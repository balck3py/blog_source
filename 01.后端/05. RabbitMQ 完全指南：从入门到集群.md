---
title: RabbitMQ å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°é›†ç¾¤
date: 2026-01-16
author: Eugen
tags:
  - RabbitMQ
  - æ¶ˆæ¯é˜Ÿåˆ—
  - MQ
  - åˆ†å¸ƒå¼
  - é«˜å¯ç”¨
  - .NET Core
  - C#
---

# ğŸ° RabbitMQ å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°é›†ç¾¤

> æœ¬æ–‡é¢å‘åˆå­¦è€…ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°é›†ç¾¤éƒ¨ç½²ï¼Œå…¨é¢ä»‹ç» RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚ä½¿ç”¨ C# ä½œä¸ºç¤ºä¾‹ä»£ç ã€‚

---

## ğŸ“š ç›®å½•

1. [RabbitMQ æ˜¯ä»€ä¹ˆ](#1-rabbitmq-æ˜¯ä»€ä¹ˆ)
2. [æ ¸å¿ƒæ¦‚å¿µè¯¦è§£](#2-æ ¸å¿ƒæ¦‚å¿µè¯¦è§£)
3. [Exchange äº¤æ¢æœºç±»å‹](#3-exchange-äº¤æ¢æœºç±»å‹)
4. [æ¶ˆæ¯å¯é æ€§ä¿è¯](#4-æ¶ˆæ¯å¯é æ€§ä¿è¯)
5. [æ­»ä¿¡é˜Ÿåˆ—](#5-æ­»ä¿¡é˜Ÿåˆ—)
6. [å»¶è¿Ÿé˜Ÿåˆ—](#6-å»¶è¿Ÿé˜Ÿåˆ—)
7. [é›†ç¾¤æ¨¡å¼](#7-é›†ç¾¤æ¨¡å¼)
8. [æ€»ç»“](#8-æ€»ç»“)

---

## 1. RabbitMQ æ˜¯ä»€ä¹ˆ

### ğŸ¤” ç”¨ç”Ÿæ´»åœºæ™¯ç†è§£

```
ä½ ç½‘è´­äº†ä¸€ä¸ªåŒ…è£¹ â†’ å¿«é€’å‘˜ â†’ å¿«é€’ç«™ï¼ˆåˆ†æ‹£ï¼‰ â†’ ä½ çš„å¿«é€’æŸœ â†’ ä½ å–ä»¶
```

å¯¹åº”åˆ° RabbitMQï¼š

```
ä½ çš„ç¨‹åºå‘æ¶ˆæ¯ â†’ RabbitMQæœåŠ¡ â†’ Exchange(åˆ†æ‹£) â†’ Queue(å¿«é€’æŸœ) â†’ æ¶ˆè´¹è€…å–æ¶ˆæ¯
```

**æœ¬è´¨ï¼š** RabbitMQ æ˜¯ä¸€ä¸ª**æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆMessage Brokerï¼‰**ï¼Œè®©ç¨‹åº A å¯ä»¥ç»™ç¨‹åº B å‘æ¶ˆæ¯ï¼Œè€Œä¸”ä¸ç”¨ç­‰ B ç«‹åˆ»å¤„ç†ã€‚

### âœ¨ è§£å†³ä»€ä¹ˆé—®é¢˜

| é—®é¢˜ | RabbitMQ è§£å†³æ–¹æ¡ˆ |
|------|-------------------|
| æœåŠ¡é—´è€¦åˆ | é€šè¿‡æ¶ˆæ¯è§£è€¦ï¼Œå‘é€æ–¹ä¸éœ€è¦çŸ¥é“æ¥æ”¶æ–¹ |
| åŒæ­¥é˜»å¡ | å¼‚æ­¥å¤„ç†ï¼Œå‘å®Œæ¶ˆæ¯ç«‹å³è¿”å› |
| æµé‡å‰Šå³° | æ¶ˆæ¯å †ç§¯åœ¨é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…æŒ‰èƒ½åŠ›å¤„ç† |
| å¯é ä¼ é€’ | æ¶ˆæ¯æŒä¹…åŒ–ï¼Œç¡®è®¤æœºåˆ¶ä¿è¯ä¸ä¸¢å¤± |

### ğŸ“ å°ç»“

> RabbitMQ æ˜¯åŸºäº AMQP åè®®çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç”¨äºå®ç°åº”ç”¨ç¨‹åºé—´çš„å¼‚æ­¥é€šä¿¡ã€è§£è€¦å’Œå‰Šå³°å¡«è°·ã€‚

---

## 2. æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### ğŸ—ï¸ æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RabbitMQ Server (Broker)                         â”‚
â”‚                          å°±åƒä¸€ä¸ª"å¿«é€’å…¬å¸"                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Virtual Host (è™šæ‹Ÿä¸»æœº)                        â”‚  â”‚
â”‚  â”‚                    å°±åƒ"å¿«é€’å…¬å¸çš„æŸä¸ªåˆ†éƒ¨"                          â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      Binding       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚  â”‚    â”‚ Exchange â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚  Queue   â”‚                   â”‚  â”‚
â”‚  â”‚    â”‚  äº¤æ¢æœº   â”‚   (è·¯ç”±è§„åˆ™/ç»‘å®š)    â”‚   é˜Ÿåˆ—   â”‚                   â”‚  â”‚
â”‚  â”‚    â”‚ "åˆ†æ‹£ä¸­å¿ƒ"â”‚                    â”‚ "å¿«é€’æŸœ" â”‚                   â”‚  â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚  â”‚         â–²                               â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                               â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                               â”‚
             â”‚ Channel (é€šé“)                â”‚ Channel (é€šé“)
             â”‚ "å¿«é€’å‘˜å’Œå…¬å¸çš„å¯¹æ¥çª—å£"         â”‚
             â”‚                               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
      â”‚ Connection  â”‚                 â”‚ Connection  â”‚
      â”‚  TCP è¿æ¥    â”‚                 â”‚  TCP è¿æ¥    â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚                               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
      â”‚  Producer   â”‚                 â”‚  Consumer   â”‚
      â”‚   ç”Ÿäº§è€…     â”‚                 â”‚   æ¶ˆè´¹è€…     â”‚
      â”‚  "å¯„ä»¶äºº"    â”‚                 â”‚  "æ”¶ä»¶äºº"    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.1 Brokerï¼ˆæ¶ˆæ¯æœåŠ¡å™¨ï¼‰

å°±æ˜¯ RabbitMQ æœåŠ¡æœ¬èº«ï¼Œå®‰è£…è¿è¡Œåå°±æ˜¯ä¸€ä¸ª Brokerã€‚

### 2.2 Connectionï¼ˆè¿æ¥ï¼‰

ç”Ÿäº§è€…/æ¶ˆè´¹è€…ä¸ RabbitMQ ä¹‹é—´çš„ **TCP è¿æ¥**ã€‚

```csharp
// åˆ›å»ºè¿æ¥å·¥å‚
var factory = new ConnectionFactory
{
    HostName = "localhost",      // RabbitMQ æœåŠ¡å™¨åœ°å€
    Port = 5672,                 // é»˜è®¤ç«¯å£
    UserName = "guest",          // ç”¨æˆ·å
    Password = "guest",          // å¯†ç 
    VirtualHost = "/"            // è™šæ‹Ÿä¸»æœº
};

// åˆ›å»ºè¿æ¥ï¼ˆTCP è¿æ¥ï¼Œæ¯”è¾ƒé‡ï¼Œå°½é‡å¤ç”¨ï¼‰
using var connection = factory.CreateConnection();
```

**å…³äºå¤šè¿æ¥ï¼š**

```csharp
var conn1 = factory.CreateConnection();  // TCP è¿æ¥ 1
var conn2 = factory.CreateConnection();  // TCP è¿æ¥ 2ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰

// æ¯æ¬¡è°ƒç”¨ CreateConnection() éƒ½ä¼šåˆ›å»ºæ–°çš„ TCP è¿æ¥
// å®ƒä»¬æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œå„è‡ªæœ‰ç‹¬ç«‹çš„å¿ƒè·³å’Œç”Ÿå‘½å‘¨æœŸ
```

**æ”¯æŒé›†ç¾¤è¿æ¥ï¼š**

```csharp
// å¤šèŠ‚ç‚¹åˆ—è¡¨ï¼ˆæ¨èï¼‰
var endpoints = new List<AmqpTcpEndpoint>
{
    new AmqpTcpEndpoint("node1.example.com", 5672),
    new AmqpTcpEndpoint("node2.example.com", 5672),
    new AmqpTcpEndpoint("node3.example.com", 5672)
};

// ä¼šæŒ‰é¡ºåºå°è¯•è¿æ¥ï¼Œç¬¬ä¸€ä¸ªæˆåŠŸçš„å°±ç”¨
var connection = factory.CreateConnection(endpoints);
```

### 2.3 Channelï¼ˆé€šé“ï¼‰

åœ¨ä¸€ä¸ª Connection é‡Œå¯ä»¥åˆ›å»ºå¤šä¸ª Channelï¼Œå°±åƒ**ä¸€æ¡å…¬è·¯ä¸Šçš„å¤šä¸ªè½¦é“**ã€‚

```csharp
// åœ¨è¿æ¥ä¸Šåˆ›å»ºé€šé“ï¼ˆè½»é‡çº§ï¼Œå¯ä»¥å¤šåˆ›å»ºï¼‰
using var channel = connection.CreateModel();
```

**ä¸ºä»€ä¹ˆéœ€è¦ Channelï¼Ÿ**

| å¯¹æ¯”é¡¹ | Connection | Channel |
|--------|------------|---------|
| æœ¬è´¨ | TCP è¿æ¥ | è™šæ‹Ÿè¿æ¥ |
| åˆ›å»ºå¼€é”€ | å¤§ | å° |
| æ•°é‡å»ºè®® | å°½é‡å¤ç”¨ | å¯ä»¥å¤šåˆ›å»º |
| ä¸Šé™ | æ— æ˜ç¡®é™åˆ¶ | åè®®ä¸Šé™ 65535 |

**âš ï¸ é‡è¦ï¼šChannel æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼**

```csharp
// âŒ é”™è¯¯åšæ³•ï¼šå¤šçº¿ç¨‹å…±ç”¨ä¸€ä¸ª Channel
var channel = connection.CreateModel();
Parallel.For(0, 100, i =>
{
    channel.BasicPublish(...);  // å¯èƒ½å¯¼è‡´æ•°æ®é”™ä¹±
});

// âœ… æ­£ç¡®åšæ³•ï¼šæ¯ä¸ªçº¿ç¨‹ç”¨è‡ªå·±çš„ Channel
Parallel.For(0, 100, i =>
{
    using var channel = connection.CreateModel();
    channel.BasicPublish(...);
});
```

**ä¸åŒ Channel å¯ä»¥å…±äº« Exchange/Queueï¼š**

```csharp
var channel1 = connection.CreateModel();
var channel2 = connection.CreateModel();

// Channel 1 åˆ›å»º Exchange
channel1.ExchangeDeclare("my.exchange", ExchangeType.Direct, durable: true);

// Channel 2 åˆ›å»º Queue å¹¶ç»‘å®šï¼ˆå®Œå…¨æ²¡é—®é¢˜ï¼ï¼‰
channel2.QueueDeclare("my.queue", durable: true);
channel2.QueueBind("my.queue", "my.exchange", "my.key");

// Exchangeã€Queue æ˜¯æœåŠ¡ç«¯èµ„æºï¼Œæ‰€æœ‰ Channel éƒ½èƒ½è®¿é—®
```

### 2.4 Virtual Hostï¼ˆè™šæ‹Ÿä¸»æœºï¼‰

ç±»ä¼¼äº MySQL çš„æ•°æ®åº“æ¦‚å¿µï¼Œ**é€»è¾‘éš”ç¦»**ã€‚ä¸åŒ VHost çš„ Exchangeã€Queue äº’ä¸å½±å“ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RabbitMQ Server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚    VHost: /prod     â”‚    â”‚    VHost: /test     â”‚    â”‚ VHost: /dev   â”‚ â”‚
â”‚   â”‚                     â”‚    â”‚                     â”‚    â”‚               â”‚ â”‚
â”‚   â”‚  order.exchange     â”‚    â”‚  order.exchange     â”‚    â”‚    ...        â”‚ â”‚
â”‚   â”‚  order.queue        â”‚    â”‚  order.queue        â”‚    â”‚               â”‚ â”‚
â”‚   â”‚  (å®Œå…¨ç‹¬ç«‹ï¼)        â”‚    â”‚  (å®Œå…¨ç‹¬ç«‹ï¼)        â”‚    â”‚               â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                           â”‚
â”‚   åŒåçš„ Exchange/Queue åœ¨ä¸åŒ VHost ä¸­æ˜¯å®Œå…¨ä¸åŒçš„èµ„æºï¼                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½¿ç”¨åœºæ™¯ï¼š**

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| å¤šç¯å¢ƒéš”ç¦» | `/prod`ã€`/staging`ã€`/dev` åˆ†å¼€ |
| å¤šç§Ÿæˆ· | æ¯ä¸ªç§Ÿæˆ·ä¸€ä¸ª VHost |
| å¤šé¡¹ç›® | åŒä¸€ä¸ª RabbitMQ ç»™å¤šä¸ªé¡¹ç›®ç”¨ |

### 2.5 Exchangeï¼ˆäº¤æ¢æœºï¼‰

**æ ¸å¿ƒç»„ä»¶ï¼** æ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œæ ¹æ®è§„åˆ™è·¯ç”±åˆ°é˜Ÿåˆ—ã€‚

```
ç”Ÿäº§è€…ä¸ç›´æ¥å‘æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œè€Œæ˜¯å‘åˆ°äº¤æ¢æœºï¼
```

### 2.6 Queueï¼ˆé˜Ÿåˆ—ï¼‰

å­˜å‚¨æ¶ˆæ¯çš„å®¹å™¨ï¼Œæ¶ˆè´¹è€…ä»è¿™é‡Œå–æ¶ˆæ¯ã€‚**å…ˆè¿›å…ˆå‡º (FIFO)**ã€‚

### 2.7 Bindingï¼ˆç»‘å®šï¼‰

Exchange å’Œ Queue ä¹‹é—´çš„å…³è”è§„åˆ™ï¼Œå‘Šè¯‰äº¤æ¢æœº"ä»€ä¹ˆæ ·çš„æ¶ˆæ¯å‘åˆ°å“ªä¸ªé˜Ÿåˆ—"ã€‚

### 2.8 Routing Keyï¼ˆè·¯ç”±é”®ï¼‰

å‘é€æ¶ˆæ¯æ—¶æŒ‡å®šçš„"æ ‡ç­¾"ï¼Œäº¤æ¢æœºæ ¹æ®è¿™ä¸ªæ ‡ç­¾å†³å®šå‘åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚

### ğŸ“‹ æ¦‚å¿µé€ŸæŸ¥è¡¨

| æ¦‚å¿µ | è‹±æ–‡ | ç±»æ¯” | ä½œç”¨ |
|------|------|------|------|
| Broker | æ¶ˆæ¯æœåŠ¡ | å¿«é€’å…¬å¸ | RabbitMQ æœåŠ¡æœ¬èº« |
| Connection | è¿æ¥ | å¼€æˆ· | TCP è¿æ¥ï¼Œé‡é‡çº§ |
| Channel | é€šé“ | çª—å£ | è™šæ‹Ÿè¿æ¥ï¼Œè½»é‡çº§ |
| VHost | è™šæ‹Ÿä¸»æœº | åˆ†å…¬å¸ | é€»è¾‘éš”ç¦» |
| Exchange | äº¤æ¢æœº | åˆ†æ‹£ä¸­å¿ƒ | è·¯ç”±æ¶ˆæ¯ |
| Queue | é˜Ÿåˆ— | å¿«é€’æŸœ | å­˜å‚¨æ¶ˆæ¯ |
| Binding | ç»‘å®š | åˆ†æ‹£è§„åˆ™ | è¿æ¥ Exchange å’Œ Queue |
| Routing Key | è·¯ç”±é”® | åœ°å€æ ‡ç­¾ | è·¯ç”±ä¾æ® |
| Message | æ¶ˆæ¯ | å¿«é€’åŒ…è£¹ | ä¼ è¾“çš„æ•°æ® |

### ğŸ“ å°ç»“

> RabbitMQ çš„æ ¸å¿ƒæ˜¯ Exchange å’Œ Queue çš„é…åˆã€‚ç”Ÿäº§è€…å‘æ¶ˆæ¯åˆ° Exchangeï¼ŒExchange æ ¹æ® Binding è§„åˆ™è·¯ç”±åˆ° Queueï¼Œæ¶ˆè´¹è€…ä» Queue å–æ¶ˆæ¯ã€‚

---

## 3. Exchange äº¤æ¢æœºç±»å‹

### ğŸ”€ ç±»å‹å¯¹æ¯”è¡¨

| ç±»å‹ | è·¯ç”±è§„åˆ™ | ä½¿ç”¨åœºæ™¯ | ç±»æ¯” |
|------|----------|----------|------|
| **Direct** | ç²¾ç¡®åŒ¹é… Routing Key | ç‚¹å¯¹ç‚¹ï¼ŒæŒ‡å®šå‘é€ | å¯„å¿«é€’å†™å…·ä½“åœ°å€ |
| **Fanout** | æ— è§† Routing Keyï¼Œå¹¿æ’­ | å¹¿æ’­é€šçŸ¥ | å°åŒºå¹¿æ’­ |
| **Topic** | é€šé…ç¬¦åŒ¹é… | åˆ†ç±»è®¢é˜… | è®¢é˜…æŠ¥çº¸åˆ†ç±» |
| **Headers** | åŒ¹é…æ¶ˆæ¯å¤´å±æ€§ | å¤æ‚è·¯ç”±ï¼ˆå°‘ç”¨ï¼‰ | æŒ‰åŒ…è£¹å±æ€§åˆ†æ‹£ |

### 3.1 Direct äº¤æ¢æœºï¼ˆç›´è¿ï¼‰

**è§„åˆ™ï¼š** Routing Key å¿…é¡»**å®Œå…¨åŒ¹é…**æ‰èƒ½è·¯ç”±ã€‚

```
                         Routing Key = "order"
Producer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Exchange (Direct)
                                                          â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                            â”‚                            â”‚
                              â–¼                            â–¼                            â–¼
                    Binding: "order"            Binding: "payment"            Binding: "log"
                              â”‚                            â”‚                            â”‚
                              â–¼                            â–¼                            â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ order.queue â”‚              â”‚payment.queueâ”‚              â”‚  log.queue  â”‚
                      â”‚     âœ…       â”‚              â”‚     âŒ       â”‚              â”‚     âŒ       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```csharp
// å£°æ˜ Direct äº¤æ¢æœº
channel.ExchangeDeclare(
    exchange: "order.direct.exchange",
    type: ExchangeType.Direct,    // ç›´è¿ç±»å‹
    durable: true                  // æŒä¹…åŒ–
);

// å£°æ˜é˜Ÿåˆ—
channel.QueueDeclare("order.queue", durable: true);

// ç»‘å®šï¼šé˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºï¼ŒæŒ‡å®š routing key
channel.QueueBind(
    queue: "order.queue",
    exchange: "order.direct.exchange",
    routingKey: "order"           // ç»‘å®šé”®
);

// å‘é€æ¶ˆæ¯æ—¶æŒ‡å®š routing key
channel.BasicPublish(
    exchange: "order.direct.exchange",
    routingKey: "order",          // å¿…é¡»å’Œç»‘å®šé”®åŒ¹é…
    body: Encoding.UTF8.GetBytes("è®¢å•æ¶ˆæ¯")
);
```

### 3.2 Fanout äº¤æ¢æœºï¼ˆæ‰‡å‡º/å¹¿æ’­ï¼‰

**è§„åˆ™ï¼š** å¿½ç•¥ Routing Keyï¼Œ**å¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—**ã€‚

```
                              æ— è§† Routing Key
Producer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Exchange (Fanout)
                                                          â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                            â”‚                            â”‚
                              â–¼                            â–¼                            â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   queue.a   â”‚              â”‚   queue.b   â”‚              â”‚   queue.c   â”‚
                      â”‚     âœ…       â”‚              â”‚     âœ…       â”‚              â”‚     âœ…       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                       æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼
```

```csharp
// å£°æ˜ Fanout äº¤æ¢æœº
channel.ExchangeDeclare(
    exchange: "notify.fanout.exchange",
    type: ExchangeType.Fanout,    // å¹¿æ’­ç±»å‹
    durable: true
);

// å¤šä¸ªé˜Ÿåˆ—éƒ½ç»‘å®šåˆ°è¿™ä¸ªäº¤æ¢æœº
channel.QueueBind("sms.queue", "notify.fanout.exchange", "");      // routing key æ— æ‰€è°“
channel.QueueBind("email.queue", "notify.fanout.exchange", "");
channel.QueueBind("wechat.queue", "notify.fanout.exchange", "");

// å‘é€æ¶ˆæ¯ï¼ˆrouting key ä¼šè¢«å¿½ç•¥ï¼‰
channel.BasicPublish(
    exchange: "notify.fanout.exchange",
    routingKey: "",               // å†™å•¥éƒ½ä¸€æ ·ï¼Œä¼šè¢«å¿½ç•¥
    body: Encoding.UTF8.GetBytes("å¹¿æ’­é€šçŸ¥æ‰€æœ‰äºº")
);
```

### 3.3 Topic äº¤æ¢æœºï¼ˆä¸»é¢˜ï¼‰

**è§„åˆ™ï¼š** Routing Key æ”¯æŒ**é€šé…ç¬¦åŒ¹é…**ã€‚

| é€šé…ç¬¦ | å«ä¹‰ | ç¤ºä¾‹ |
|--------|------|------|
| `*` | åŒ¹é…**ä¸€ä¸ª**å•è¯ | `order.*` åŒ¹é… `order.create`ï¼Œä¸åŒ¹é… `order.create.vip` |
| `#` | åŒ¹é…**é›¶ä¸ªæˆ–å¤šä¸ª**å•è¯ | `order.#` åŒ¹é… `order`ã€`order.create`ã€`order.create.vip` |

```
Producer å‘é€ Routing Key = "order.create.vip"
                              â”‚
                              â–¼
                      Exchange (Topic)
                              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                   â”‚                   â”‚
          â–¼                   â–¼                   â–¼
    Binding: order.*    Binding: order.#    Binding: *.create.*
          â”‚                   â”‚                   â”‚
          â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  queue.a  â”‚       â”‚  queue.b  â”‚       â”‚  queue.c  â”‚
    â”‚    âŒ      â”‚       â”‚    âœ…      â”‚       â”‚    âœ…      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    order.* åªåŒ¹é…ä¸€å±‚      order.# åŒ¹é…å¤šå±‚     *.create.* ä¸­é—´åŒ¹é…
```

```csharp
// å£°æ˜ Topic äº¤æ¢æœº
channel.ExchangeDeclare(
    exchange: "log.topic.exchange",
    type: ExchangeType.Topic,
    durable: true
);

// ç»‘å®šä¸åŒçš„æ¨¡å¼
channel.QueueBind("all.log.queue", "log.topic.exchange", "#");           // æ¥æ”¶æ‰€æœ‰æ—¥å¿—
channel.QueueBind("error.queue", "log.topic.exchange", "*.error");       // åªæ¥æ”¶ error çº§åˆ«
channel.QueueBind("order.queue", "log.topic.exchange", "order.#");       // æ¥æ”¶æ‰€æœ‰è®¢å•æ—¥å¿—

// å‘é€æ¶ˆæ¯ç¤ºä¾‹
channel.BasicPublish("log.topic.exchange", "order.error", null, body);
// è¢« all.log.queueã€error.queueã€order.queue ä¸‰ä¸ªé˜Ÿåˆ—éƒ½æ”¶åˆ°

channel.BasicPublish("log.topic.exchange", "user.info", null, body);
// åªè¢« all.log.queue æ”¶åˆ°
```

### 3.4 Headers äº¤æ¢æœºï¼ˆä¸å¸¸ç”¨ï¼‰

æ ¹æ®æ¶ˆæ¯çš„ **Headers å±æ€§**åŒ¹é…ï¼Œè€Œä¸æ˜¯ Routing Keyã€‚

```csharp
// ç»‘å®šæ—¶æŒ‡å®šåŒ¹é…è§„åˆ™
var bindArgs = new Dictionary<string, object>
{
    { "x-match", "all" },     // all = å…¨éƒ¨åŒ¹é…ï¼Œany = ä»»ä¸€åŒ¹é…
    { "format", "pdf" },
    { "type", "report" }
};
channel.QueueBind("report.queue", "headers.exchange", "", bindArgs);
```

### âš™ï¸ å¸¸ç”¨å‚æ•°è¯¦è§£

**Exchange å‚æ•°ï¼š**

```csharp
channel.ExchangeDeclare(
    exchange: "my.exchange",     // äº¤æ¢æœºåç§°
    type: ExchangeType.Direct,   // ç±»å‹
    durable: true,               // æŒä¹…åŒ–ï¼ˆé‡å¯ä¸ä¸¢å¤±ï¼‰
    autoDelete: false,           // æ— ç»‘å®šæ—¶è‡ªåŠ¨åˆ é™¤
    arguments: null              // é¢å¤–å‚æ•°
);
```

**Queue å‚æ•°ï¼š**

```csharp
channel.QueueDeclare(
    queue: "my.queue",
    durable: true,               // æŒä¹…åŒ–
    exclusive: false,            // æ’ä»–é˜Ÿåˆ—
    autoDelete: false,           // è‡ªåŠ¨åˆ é™¤
    arguments: new Dictionary<string, object>
    {
        { "x-message-ttl", 60000 },           // æ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        { "x-max-length", 1000 },             // é˜Ÿåˆ—æœ€å¤§æ¶ˆæ¯æ•°
        { "x-dead-letter-exchange", "dlx" },  // æ­»ä¿¡äº¤æ¢æœº
        { "x-dead-letter-routing-key", "dlk" } // æ­»ä¿¡è·¯ç”±é”®
    }
);
```

**Message å‚æ•°ï¼š**

```csharp
var properties = channel.CreateBasicProperties();
properties.Persistent = true;              // æ¶ˆæ¯æŒä¹…åŒ–
properties.Expiration = "60000";           // æ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼Œå­—ç¬¦ä¸²ï¼‰
properties.Priority = 5;                   // ä¼˜å…ˆçº§ 0-9
properties.Headers = new Dictionary<string, object>();  // è‡ªå®šä¹‰å¤´
```

> ğŸ’¡ **æç¤ºï¼š** `Persistent` å’Œ `DeliveryMode = 2` æ•ˆæœç›¸åŒï¼Œ`Persistent` æ˜¯è¯­æ³•ç³–ã€‚

### ğŸ“ å°ç»“

> å››ç§äº¤æ¢æœºç±»å‹æ»¡è¶³ä¸åŒåœºæ™¯ï¼šDirect ç”¨äºç²¾ç¡®è·¯ç”±ï¼ŒFanout ç”¨äºå¹¿æ’­ï¼ŒTopic ç”¨äºæ¨¡å¼åŒ¹é…ï¼ŒHeaders ç”¨äºå¤æ‚æ¡ä»¶è·¯ç”±ã€‚

---

## 4. æ¶ˆæ¯å¯é æ€§ä¿è¯

### ğŸ¯ æ¶ˆæ¯ä¼ é€’çš„å®Œæ•´é“¾è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â‘       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â‘¡      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â‘¢      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Producer â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Exchange â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Queue   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Consumer â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                       â”‚                       â”‚                       â”‚
     â”‚   Confirm æœºåˆ¶        â”‚    Mandatory/AE      â”‚                       â”‚   Ack æœºåˆ¶
     â”‚   ç¡®è®¤åˆ°è¾¾äº¤æ¢æœº       â”‚    ç¡®è®¤è·¯ç”±åˆ°é˜Ÿåˆ—     â”‚                       â”‚   ç¡®è®¤æ¶ˆè´¹æˆåŠŸ
     â–¼                       â–¼                       â–¼                       â–¼

 ä»»ä½•ä¸€ä¸ªç¯èŠ‚éƒ½å¯èƒ½ä¸¢æ¶ˆæ¯ï¼
```

| é˜¶æ®µ | å¯èƒ½çš„é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|-----------|----------|
| â‘  Producer â†’ Exchange | ç½‘ç»œæ–­å¼€ã€Exchange ä¸å­˜åœ¨ | **Publisher Confirm** |
| â‘¡ Exchange â†’ Queue | æ²¡æœ‰åŒ¹é…çš„é˜Ÿåˆ— | **Mandatory + Return** æˆ– **å¤‡ç”¨äº¤æ¢æœº** |
| â‘¢ Queue â†’ Consumer | æ¶ˆè´¹è€…å¤„ç†å¤±è´¥ | **Consumer Ack** |

### 4.1 ç”Ÿäº§è€…ç¡®è®¤ï¼ˆPublisher Confirmï¼‰

**ç¡®è®¤æ¶ˆæ¯å·²åˆ°è¾¾ Exchange**ï¼ˆæ³¨æ„ï¼šä¸æ˜¯åˆ°è¾¾ Queueï¼ï¼‰

#### å¼‚æ­¥ç¡®è®¤ï¼ˆæ¨èï¼‰

```csharp
var channel = connection.CreateModel();
channel.ConfirmSelect();  // å¼€å¯ç¡®è®¤æ¨¡å¼

// ç”¨äºè¿½è¸ªæœªç¡®è®¤çš„æ¶ˆæ¯
var pendingConfirms = new ConcurrentDictionary<ulong, string>();

// ç¡®è®¤æˆåŠŸå›è°ƒ
channel.BasicAcks += (sender, ea) =>
{
    if (ea.Multiple)
    {
        // æ‰¹é‡ç¡®è®¤ï¼šea.DeliveryTag åŠä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ç¡®è®¤äº†
        var confirmed = pendingConfirms.Where(k => k.Key <= ea.DeliveryTag);
        foreach (var entry in confirmed)
        {
            pendingConfirms.TryRemove(entry.Key, out _);
        }
    }
    else
    {
        pendingConfirms.TryRemove(ea.DeliveryTag, out _);
    }
};

// ç¡®è®¤å¤±è´¥å›è°ƒ
channel.BasicNacks += (sender, ea) =>
{
    pendingConfirms.TryGetValue(ea.DeliveryTag, out string message);
    Console.WriteLine($"æ¶ˆæ¯ {ea.DeliveryTag} è¢«æ‹’ç»ï¼Œéœ€è¦é‡å‘");
};

// å‘é€æ¶ˆæ¯
for (int i = 0; i < 1000; i++)
{
    var body = Encoding.UTF8.GetBytes($"æ¶ˆæ¯ {i}");
    ulong sequenceNumber = channel.NextPublishSeqNo;  // è·å–åºå·
    pendingConfirms.TryAdd(sequenceNumber, $"æ¶ˆæ¯ {i}");
    channel.BasicPublish("my.exchange", "my.key", null, body);
}
```

### 4.2 ç¡®ä¿æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—

**Publisher Confirm åªèƒ½ç¡®è®¤åˆ°è¾¾ Exchangeï¼Œä¸èƒ½ç¡®è®¤åˆ°è¾¾ Queueï¼**

#### æ–¹æ¡ˆä¸€ï¼šMandatory + Return

```csharp
// æ¶ˆæ¯æ— æ³•è·¯ç”±æ—¶çš„å›è°ƒ
channel.BasicReturn += (sender, ea) =>
{
    var body = Encoding.UTF8.GetString(ea.Body.ToArray());
    Console.WriteLine($"æ¶ˆæ¯è¢«é€€å›: {body}");
};

// mandatory=trueï¼šæ— æ³•è·¯ç”±æ—¶è§¦å‘ BasicReturn
channel.BasicPublish(
    exchange: "my.exchange",
    routingKey: "wrong.key",
    mandatory: true,           // å…³é”®å‚æ•°ï¼
    body: body
);
```

#### æ–¹æ¡ˆäºŒï¼šå¤‡ç”¨äº¤æ¢æœºï¼ˆAlternate Exchangeï¼‰

```csharp
// åˆ›å»ºå¤‡ç”¨äº¤æ¢æœº
channel.ExchangeDeclare("backup.exchange", ExchangeType.Fanout, durable: true);
channel.QueueDeclare("backup.queue", durable: true);
channel.QueueBind("backup.queue", "backup.exchange", "");

// ä¸»äº¤æ¢æœºæŒ‡å®šå¤‡ç”¨äº¤æ¢æœº
var args = new Dictionary<string, object>
{
    { "alternate-exchange", "backup.exchange" }
};
channel.ExchangeDeclare("main.exchange", ExchangeType.Direct, durable: true, arguments: args);
```

### 4.3 æ¶ˆè´¹è€…ç¡®è®¤ï¼ˆConsumer Ackï¼‰

| æ¨¡å¼ | å‚æ•° | è¯´æ˜ |
|------|------|------|
| è‡ªåŠ¨ç¡®è®¤ | `autoAck: true` | æ¶ˆæ¯å–å‡ºå³åˆ é™¤ï¼Œå±é™© |
| æ‰‹åŠ¨ç¡®è®¤ | `autoAck: false` | éœ€è°ƒç”¨ `BasicAck` |

```csharp
var consumer = new EventingBasicConsumer(channel);

consumer.Received += (model, ea) =>
{
    try
    {
        var message = Encoding.UTF8.GetString(ea.Body.ToArray());
        ProcessMessage(message);  // å¤„ç†ä¸šåŠ¡

        // âœ… å¤„ç†æˆåŠŸï¼Œç¡®è®¤æ¶ˆæ¯
        channel.BasicAck(ea.DeliveryTag, multiple: false);
    }
    catch (Exception ex)
    {
        // âŒ å¤„ç†å¤±è´¥
        // requeue: true = é‡æ–°å…¥é˜Ÿï¼Œfalse = ä¸¢å¼ƒæˆ–è¿›æ­»ä¿¡é˜Ÿåˆ—
        channel.BasicNack(ea.DeliveryTag, multiple: false, requeue: false);
    }
};

channel.BasicConsume("my.queue", autoAck: false, consumer: consumer);
```

### 4.4 é¢„å–æ•°é‡ï¼ˆPrefetchï¼‰

æ§åˆ¶æ¶ˆè´¹è€…ä¸€æ¬¡èƒ½æ‹¿å¤šå°‘æ¡æœªç¡®è®¤çš„æ¶ˆæ¯ã€‚

```csharp
channel.BasicQos(
    prefetchSize: 0,      // æ¶ˆæ¯å¤§å°é™åˆ¶ï¼Œ0=ä¸é™
    prefetchCount: 10,    // æœ€å¤š 10 æ¡æœªç¡®è®¤æ¶ˆæ¯
    global: false         // é’ˆå¯¹å½“å‰ Channel
);
```

### ğŸ“‹ å¯é æ€§é…ç½®æ¸…å•

| ç¯èŠ‚ | é…ç½® | ä½œç”¨ |
|------|------|------|
| äº¤æ¢æœº | `durable: true` | é‡å¯ä¸ä¸¢å¤± |
| é˜Ÿåˆ— | `durable: true` | é‡å¯ä¸ä¸¢å¤± |
| æ¶ˆæ¯ | `Persistent: true` | æŒä¹…åŒ–åˆ°ç£ç›˜ |
| ç”Ÿäº§è€… | `ConfirmSelect()` | å¼€å¯å‘å¸ƒç¡®è®¤ |
| ç”Ÿäº§è€… | `mandatory: true` | æ— æ³•è·¯ç”±æ—¶é€€å› |
| æ¶ˆè´¹è€… | `autoAck: false` | æ‰‹åŠ¨ç¡®è®¤ |
| æ¶ˆè´¹è€… | `BasicQos` | æ§åˆ¶é¢„å–æ•°é‡ |

### ğŸ“ å°ç»“

> æ¶ˆæ¯å¯é æ€§éœ€è¦ä¸‰ä¸ªç¯èŠ‚é…åˆï¼šç”Ÿäº§è€…ç¡®è®¤ï¼ˆConfirmï¼‰ä¿è¯æ¶ˆæ¯åˆ°è¾¾ Exchangeï¼Œmandatory/å¤‡ç”¨äº¤æ¢æœºä¿è¯è·¯ç”±åˆ° Queueï¼Œæ¶ˆè´¹è€…ç¡®è®¤ï¼ˆAckï¼‰ä¿è¯æˆåŠŸæ¶ˆè´¹ã€‚

---

## 5. æ­»ä¿¡é˜Ÿåˆ—

### ğŸ¯ ä»€ä¹ˆæ˜¯æ­»ä¿¡ï¼Ÿ

**æ­»ä¿¡ï¼ˆDead Letterï¼‰** = æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹çš„æ¶ˆæ¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   æ­£å¸¸é˜Ÿåˆ—                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚   â”‚ [æ¶ˆæ¯1] [æ¶ˆæ¯2] [æ¶ˆæ¯3] [æ¶ˆæ¯4] [æ¶ˆæ¯5]   â”‚                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â”‚  æŸäº›æ¶ˆæ¯"æ­»äº†"                                                     â”‚
â”‚        â”‚  - è¢«æ‹’ç»                                                          â”‚
â”‚        â”‚  - è¿‡æœŸäº†                                                          â”‚
â”‚        â”‚  - é˜Ÿåˆ—æ»¡äº†                                                        â”‚
â”‚        â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚   â”‚         æ­»ä¿¡äº¤æ¢æœº (DLX)                  â”‚                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚   â”‚         æ­»ä¿¡é˜Ÿåˆ— (DLQ)                   â”‚  â† ä¸“é—¨å­˜æ”¾"æ­»æ‰"çš„æ¶ˆæ¯         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“‹ æ¶ˆæ¯å˜æˆæ­»ä¿¡çš„ä¸‰ç§æƒ…å†µ

| æƒ…å†µ | è§¦å‘æ¡ä»¶ | è¯´æ˜ |
|------|----------|------|
| **è¢«æ‹’ç»** | `BasicNack`/`BasicReject` ä¸” `requeue=false` | æ¶ˆè´¹è€…æ˜ç¡®æ‹’ç» |
| **æ¶ˆæ¯è¿‡æœŸ** | TTL åˆ°æœŸ | æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­å¾…å¤ªä¹… |
| **é˜Ÿåˆ—æ»¡äº†** | è¶…è¿‡ `x-max-length` | è€æ¶ˆæ¯è¢«æŒ¤å‡º |

### 5.1 é…ç½®æ­»ä¿¡é˜Ÿåˆ—

```csharp
// 1. åˆ›å»ºæ­»ä¿¡äº¤æ¢æœº
channel.ExchangeDeclare("dlx.exchange", ExchangeType.Direct, durable: true);

// 2. åˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—
channel.QueueDeclare("dlx.queue", durable: true);

// 3. ç»‘å®š
channel.QueueBind("dlx.queue", "dlx.exchange", "dlx.routing.key");

// 4. åˆ›å»ºæ­£å¸¸é˜Ÿåˆ—ï¼ŒæŒ‡å®šæ­»ä¿¡äº¤æ¢æœº
var args = new Dictionary<string, object>
{
    { "x-dead-letter-exchange", "dlx.exchange" },
    { "x-dead-letter-routing-key", "dlx.routing.key" },
    { "x-message-ttl", 30000 }  // 30ç§’è¿‡æœŸ
};
channel.QueueDeclare("normal.queue", durable: true, arguments: args);
```

### 5.2 æ¶ˆè´¹æ­»ä¿¡é˜Ÿåˆ—

æ­»ä¿¡é˜Ÿåˆ—å°±æ˜¯æ™®é€šé˜Ÿåˆ—ï¼Œæ¶ˆè´¹æ–¹å¼å®Œå…¨ä¸€æ ·ï¼š

```csharp
var dlxConsumer = new EventingBasicConsumer(channel);

dlxConsumer.Received += (model, ea) =>
{
    var message = Encoding.UTF8.GetString(ea.Body.ToArray());
    var headers = ea.BasicProperties.Headers;

    // è·å–æ­»ä¿¡å…ƒæ•°æ®
    if (headers != null && headers.ContainsKey("x-death"))
    {
        var xDeath = (List<object>)headers["x-death"];
        var deathInfo = (Dictionary<string, object>)xDeath[0];
        var reason = Encoding.UTF8.GetString((byte[])deathInfo["reason"]);
        Console.WriteLine($"æ­»ä¿¡åŸå› : {reason}");  // rejected / expired / maxlen
    }

    // å¤„ç†æ­»ä¿¡ï¼šè®°å½•æ—¥å¿—ã€å‘é€å‘Šè­¦ã€äººå·¥å¤„ç†ç­‰
    channel.BasicAck(ea.DeliveryTag, false);
};

channel.BasicConsume("dlx.queue", autoAck: false, consumer: dlxConsumer);
```

### 5.3 æ­»ä¿¡é‡è¯•æœºåˆ¶

```
æ¶ˆè´¹å¤±è´¥ â†’ è¿›å…¥å»¶è¿Ÿé˜Ÿåˆ—(å¸¦TTL) â†’ è¿‡æœŸåå›åˆ°åŸé˜Ÿåˆ— â†’ å†æ¬¡æ¶ˆè´¹
```

```csharp
// æ­£å¸¸é˜Ÿåˆ— â†’ æ­»ä¿¡å»é‡è¯•äº¤æ¢æœº
var normalArgs = new Dictionary<string, object>
{
    { "x-dead-letter-exchange", "retry.exchange" }
};
channel.QueueDeclare("order.queue", durable: true, arguments: normalArgs);

// é‡è¯•é˜Ÿåˆ— â†’ è¿‡æœŸåå›åˆ°æ­£å¸¸äº¤æ¢æœº
var retryArgs = new Dictionary<string, object>
{
    { "x-dead-letter-exchange", "order.exchange" },
    { "x-message-ttl", 30000 }  // 30ç§’åé‡è¯•
};
channel.QueueDeclare("retry.queue", durable: true, arguments: retryArgs);
```

### ğŸ“ å°ç»“

> æ­»ä¿¡é˜Ÿåˆ—ç”¨äºå¤„ç†æ— æ³•æ­£å¸¸æ¶ˆè´¹çš„æ¶ˆæ¯ï¼ŒåŒ…æ‹¬è¢«æ‹’ç»ã€è¿‡æœŸã€é˜Ÿåˆ—æ»¡çš„æƒ…å†µã€‚å®ƒæ˜¯å®ç°é‡è¯•æœºåˆ¶å’Œå¼‚å¸¸ç›‘æ§çš„é‡è¦æ‰‹æ®µã€‚

---

## 6. å»¶è¿Ÿé˜Ÿåˆ—

### ğŸ¯ ä»€ä¹ˆæ˜¯å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ

æ¶ˆæ¯å‘é€åï¼Œ**ä¸ä¼šç«‹å³è¢«æ¶ˆè´¹**ï¼Œè€Œæ˜¯ç­‰å¾…æŒ‡å®šæ—¶é—´åæ‰èƒ½è¢«æ¶ˆè´¹ã€‚

### 6.1 å®ç°æ–¹å¼ä¸€ï¼šTTL + æ­»ä¿¡é˜Ÿåˆ—

```
ç”Ÿäº§è€… â†’ å»¶è¿Ÿé˜Ÿåˆ—(è®¾ç½®TTLï¼Œæ— æ¶ˆè´¹è€…) â†’ æ¶ˆæ¯è¿‡æœŸ â†’ æ­»ä¿¡äº¤æ¢æœº â†’ å®é™…æ¶ˆè´¹é˜Ÿåˆ— â†’ æ¶ˆè´¹è€…
```

```csharp
// 1. åˆ›å»ºå®é™…æ¶ˆè´¹çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—
channel.ExchangeDeclare("process.exchange", ExchangeType.Direct, durable: true);
channel.QueueDeclare("process.queue", durable: true);
channel.QueueBind("process.queue", "process.exchange", "order");

// 2. åˆ›å»ºå»¶è¿Ÿé˜Ÿåˆ—ï¼ˆè®¾ç½® TTL å’Œæ­»ä¿¡äº¤æ¢æœºï¼‰
var delayArgs = new Dictionary<string, object>
{
    { "x-dead-letter-exchange", "process.exchange" },
    { "x-dead-letter-routing-key", "order" },
    { "x-message-ttl", 30000 }  // 30ç§’å»¶è¿Ÿ
};
channel.QueueDeclare("delay.queue", durable: true, arguments: delayArgs);

// 3. å‘é€åˆ°å»¶è¿Ÿé˜Ÿåˆ—
channel.BasicPublish("", "delay.queue", null, body);
// 30ç§’åæ¶ˆæ¯ä¼šè‡ªåŠ¨è¿›å…¥ process.queue
```

> âš ï¸ **ç¼ºé™·ï¼š** é˜Ÿåˆ—æ˜¯ FIFOï¼Œå¦‚æœå‰é¢çš„æ¶ˆæ¯ TTL è¾ƒé•¿ï¼Œåé¢çŸ­ TTL çš„æ¶ˆæ¯ä¼šè¢«é˜»å¡ã€‚

### 6.2 å®ç°æ–¹å¼äºŒï¼šå»¶è¿Ÿæ’ä»¶ï¼ˆæ¨èï¼‰

å®‰è£… `rabbitmq_delayed_message_exchange` æ’ä»¶ï¼š

```bash
rabbitmq-plugins enable rabbitmq_delayed_message_exchange
```

```csharp
// å£°æ˜å»¶è¿Ÿäº¤æ¢æœº
var args = new Dictionary<string, object>
{
    { "x-delayed-type", "direct" }
};
channel.ExchangeDeclare("delayed.exchange", "x-delayed-message", durable: true, arguments: args);

// å‘é€å»¶è¿Ÿæ¶ˆæ¯
var properties = channel.CreateBasicProperties();
properties.Headers = new Dictionary<string, object>
{
    { "x-delay", 30000 }  // å»¶è¿Ÿ 30 ç§’
};
channel.BasicPublish("delayed.exchange", "order.key", properties, body);
```

### ğŸ“‹ ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| è®¢å•è¶…æ—¶å–æ¶ˆ | ä¸‹å•å 30 åˆ†é’Ÿæœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ |
| å»¶è¿Ÿé€šçŸ¥ | ä¼šè®®å¼€å§‹å‰ 15 åˆ†é’Ÿæé†’ |
| é‡è¯•æœºåˆ¶ | å¤±è´¥åå»¶è¿Ÿ N ç§’é‡è¯• |

### ğŸ“ å°ç»“

> å»¶è¿Ÿé˜Ÿåˆ—å¯é€šè¿‡ TTL+æ­»ä¿¡æˆ–å»¶è¿Ÿæ’ä»¶å®ç°ã€‚æ’ä»¶æ–¹å¼æ›´çµæ´»ï¼Œæ”¯æŒä»»æ„å»¶è¿Ÿæ—¶é—´ä¸”ä¸ä¼šé˜»å¡ã€‚

---

## 7. é›†ç¾¤æ¨¡å¼

### ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦é›†ç¾¤ï¼Ÿ

| å•èŠ‚ç‚¹é—®é¢˜ | é›†ç¾¤è§£å†³æ–¹æ¡ˆ |
|-----------|-------------|
| å•ç‚¹æ•…éšœ | å¤šèŠ‚ç‚¹å®¹é”™ |
| æ€§èƒ½ç“¶é¢ˆ | è´Ÿè½½åˆ†æ•£ |
| å­˜å‚¨å—é™ | æ•°æ®åˆ†å¸ƒ |

### 7.1 é›†ç¾¤æ¨¡å¼æ¼”è¿›

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ™®é€šé›†ç¾¤æ¨¡å¼    â”‚    â”‚    é•œåƒé˜Ÿåˆ—      â”‚    â”‚    ä»²è£é˜Ÿåˆ—      â”‚
â”‚ (Classic Cluster)â”‚    â”‚(Mirrored Queue) â”‚    â”‚ (Quorum Queue)  â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚   å…ƒæ•°æ®åŒæ­¥      â”‚    â”‚   æ•°æ®å®Œå…¨é•œåƒ   â”‚    â”‚   Raft å…±è¯†      â”‚
â”‚   é˜Ÿåˆ—æ•°æ®ä¸åŒæ­¥  â”‚    â”‚   ä¸»ä»å¤åˆ¶       â”‚    â”‚   å¼ºä¸€è‡´æ€§       â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚   âš ï¸ æ•°æ®å¯èƒ½ä¸¢å¤± â”‚    â”‚   âš ï¸ å·²åºŸå¼ƒ      â”‚    â”‚   âœ… æ¨èä½¿ç”¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ™®é€šé›†ç¾¤æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ™®é€šé›†ç¾¤æ¨¡å¼                                      â”‚
â”‚                                                                             â”‚
â”‚     Node A                    Node B                    Node C              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚             â”‚          â”‚             â”‚          â”‚             â”‚         â”‚
â”‚   â”‚  Exchange â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–º Exchange â—„â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–º Exchange  â”‚         â”‚
â”‚   â”‚  (åŒæ­¥)     â”‚          â”‚   (åŒæ­¥)    â”‚          â”‚   (åŒæ­¥)    â”‚         â”‚
â”‚   â”‚             â”‚          â”‚             â”‚          â”‚             â”‚         â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚             â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚
â”‚   â”‚ â”‚ Queue A â”‚ â”‚          â”‚  (æ— æ•°æ®)    â”‚          â”‚ â”‚ Queue C â”‚ â”‚         â”‚
â”‚   â”‚ â”‚ [æ•°æ®]  â”‚ â”‚          â”‚             â”‚          â”‚ â”‚ [æ•°æ®]  â”‚ â”‚         â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚             â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”‚   é˜Ÿåˆ—æ•°æ®åªå­˜åœ¨äºåˆ›å»ºå®ƒçš„é‚£ä¸ªèŠ‚ç‚¹ï¼                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| æ•°æ®ç±»å‹ | æ˜¯å¦åŒæ­¥ |
|----------|----------|
| å…ƒæ•°æ®ï¼ˆExchangeã€Bindingã€Queue å®šä¹‰ï¼‰ | âœ… åŒæ­¥ |
| é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°æ® | âŒ ä¸åŒæ­¥ |

**é—®é¢˜ï¼š** èŠ‚ç‚¹å®•æœºï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„é˜Ÿåˆ—æ•°æ®ä¸å¯ç”¨ï¼

### 7.3 ä»²è£é˜Ÿåˆ—ï¼ˆQuorum Queueï¼‰âœ… æ¨è

åŸºäº **Raft å…±è¯†ç®—æ³•**ï¼Œä¿è¯æ•°æ®å¼ºä¸€è‡´æ€§ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             ä»²è£é˜Ÿåˆ—æ¨¡å¼                                     â”‚
â”‚                              (Raft å…±è¯†)                                    â”‚
â”‚                                                                             â”‚
â”‚     Node A (Leader)          Node B (Follower)       Node C (Follower)      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  å¤åˆ¶    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  å¤åˆ¶    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚
â”‚   â”‚ â”‚ Queue   â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â–º â”‚ â”‚ Queue   â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â–º â”‚ â”‚ Queue   â”‚ â”‚         â”‚
â”‚   â”‚ â”‚ (Leader)â”‚ â”‚          â”‚ â”‚(Follower)â”‚ â”‚          â”‚ â”‚(Follower)â”‚ â”‚         â”‚
â”‚   â”‚ â”‚ [æ•°æ®]  â”‚ â”‚          â”‚ â”‚ [æ•°æ®]  â”‚ â”‚          â”‚ â”‚ [æ•°æ®]  â”‚ â”‚         â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”‚   å†™å…¥ç¡®è®¤ï¼šå¿…é¡»å¤šæ•°èŠ‚ç‚¹(2/3)å†™å…¥æˆåŠŸæ‰ç®—æˆåŠŸ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å£°æ˜ä»²è£é˜Ÿåˆ—ï¼š**

```csharp
var args = new Dictionary<string, object>
{
    { "x-queue-type", "quorum" }  // å…³é”®å‚æ•°ï¼
};

channel.QueueDeclare(
    queue: "order.quorum.queue",
    durable: true,                 // ä»²è£é˜Ÿåˆ—å¿…é¡»æŒä¹…åŒ–
    exclusive: false,              // ä¸èƒ½æ˜¯æ’ä»–çš„
    autoDelete: false,             // ä¸èƒ½è‡ªåŠ¨åˆ é™¤
    arguments: args
);
```

### 7.4 èŠ‚ç‚¹æ•…éšœå¤„ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯1ï¼šFollower èŠ‚ç‚¹å®•æœº                                               â”‚
â”‚                                                                       â”‚
â”‚   Node A (Leader)     Node B (Follower)     Node C (Follower)         â”‚
â”‚        âœ…                   âŒ å®•æœº              âœ…                     â”‚
â”‚                                                                       â”‚
â”‚   å½±å“ï¼šå‡ ä¹æ— å½±å“                                                     â”‚
â”‚   - Leader ç»§ç»­å·¥ä½œ                                                   â”‚
â”‚   - å†™å…¥åªéœ€ 2/3 ç¡®è®¤ï¼Œä»ç„¶æ»¡è¶³                                        â”‚
â”‚   - Node B æ¢å¤åè‡ªåŠ¨åŒæ­¥æ•°æ®                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯2ï¼šLeader èŠ‚ç‚¹å®•æœº                                                 â”‚
â”‚                                                                       â”‚
â”‚   Node A (Leader)     Node B (Follower)     Node C (Follower)         â”‚
â”‚        âŒ å®•æœº             âœ…                    âœ…                     â”‚
â”‚                                                                       â”‚
â”‚   â†’ Raft è‡ªåŠ¨é€‰ä¸¾æ–° Leaderï¼ˆé€šå¸¸ < 1ç§’ï¼‰                               â”‚
â”‚                                                                       â”‚
â”‚   Node A (ç¦»çº¿)       Node B (æ–° Leader)    Node C (Follower)         â”‚
â”‚        âŒ                   âœ…                    âœ…                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.5 å®¢æˆ·ç«¯é«˜å¯ç”¨é…ç½®

```csharp
var factory = new ConnectionFactory
{
    UserName = "guest",
    Password = "guest",
    AutomaticRecoveryEnabled = true,       // è‡ªåŠ¨æ¢å¤è¿æ¥
    NetworkRecoveryInterval = TimeSpan.FromSeconds(5),
    TopologyRecoveryEnabled = true,        // è‡ªåŠ¨æ¢å¤ Exchange/Queue
    RequestedHeartbeat = TimeSpan.FromSeconds(30)
};

var endpoints = new List<AmqpTcpEndpoint>
{
    new AmqpTcpEndpoint("node1.rabbitmq.local", 5672),
    new AmqpTcpEndpoint("node2.rabbitmq.local", 5672),
    new AmqpTcpEndpoint("node3.rabbitmq.local", 5672)
};

var connection = factory.CreateConnection(endpoints);

// ç›‘å¬äº‹ä»¶
connection.ConnectionShutdown += (sender, args) =>
{
    Console.WriteLine($"è¿æ¥æ–­å¼€: {args.ReplyText}");
};

connection.RecoverySucceeded += (sender, args) =>
{
    Console.WriteLine("è¿æ¥æ¢å¤æˆåŠŸ");
};
```

### ğŸ“Š é›†ç¾¤æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | æ™®é€šé›†ç¾¤ | é•œåƒé˜Ÿåˆ— | ä»²è£é˜Ÿåˆ— |
|------|----------|----------|----------|
| æ•°æ®åŒæ­¥ | åªåŒæ­¥å…ƒæ•°æ® | å¼‚æ­¥å¤åˆ¶ | Raft å¤šæ•°ç¡®è®¤ |
| ä¸€è‡´æ€§ | æ—  | æœ€ç»ˆä¸€è‡´ | å¼ºä¸€è‡´ |
| èŠ‚ç‚¹å®•æœº | æ•°æ®ä¸å¯ç”¨ | è‡ªåŠ¨åˆ‡æ¢ | è‡ªåŠ¨é€‰ä¸¾ |
| æ€§èƒ½ | æœ€é«˜ | ä¸­ç­‰ | ç•¥ä½ |
| çŠ¶æ€ | åŸºç¡€ | å·²åºŸå¼ƒ | **æ¨è** |

### ğŸ“ å°ç»“

> ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ä»²è£é˜Ÿåˆ—ï¼ˆQuorum Queueï¼‰ï¼Œå®ƒåŸºäº Raft ç®—æ³•ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œé…åˆå®¢æˆ·ç«¯è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼Œå®ç°çœŸæ­£çš„é«˜å¯ç”¨ã€‚

---

## 8. æ€»ç»“

### ğŸ¯ æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥è¡¨

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| **Exchange** | äº¤æ¢æœºï¼Œè·¯ç”±æ¶ˆæ¯åˆ°é˜Ÿåˆ— |
| **Queue** | é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯ |
| **Binding** | ç»‘å®šè§„åˆ™ |
| **Routing Key** | è·¯ç”±é”® |
| **Confirm** | ç”Ÿäº§è€…ç¡®è®¤ |
| **Ack** | æ¶ˆè´¹è€…ç¡®è®¤ |
| **DLX** | æ­»ä¿¡äº¤æ¢æœº |
| **TTL** | æ¶ˆæ¯/é˜Ÿåˆ—è¿‡æœŸæ—¶é—´ |
| **Quorum Queue** | ä»²è£é˜Ÿåˆ—ï¼Œå¼ºä¸€è‡´æ€§ |

### âœ¨ æœ€ä½³å®è·µ

1. **æŒä¹…åŒ–é…ç½®**
   - Exchange: `durable: true`
   - Queue: `durable: true`
   - Message: `Persistent: true`

2. **å¯é æ€§ä¿è¯**
   - å¼€å¯ Publisher Confirm
   - ä½¿ç”¨æ‰‹åŠ¨ Ack
   - é…ç½®æ­»ä¿¡é˜Ÿåˆ—

3. **é«˜å¯ç”¨éƒ¨ç½²**
   - è‡³å°‘ 3 ä¸ªèŠ‚ç‚¹ï¼ˆå¥‡æ•°ï¼‰
   - ä½¿ç”¨ä»²è£é˜Ÿåˆ—
   - å®¢æˆ·ç«¯é…ç½®è‡ªåŠ¨æ¢å¤

4. **æ€§èƒ½ä¼˜åŒ–**
   - åˆç†è®¾ç½® Prefetch
   - å¤ç”¨ Connectionï¼ŒæŒ‰éœ€åˆ›å»º Channel
   - æ‰¹é‡å‘é€å’Œç¡®è®¤

### ğŸ“ å­¦ä¹ è·¯å¾„

1. **å…¥é—¨**ï¼šç†è§£ Exchangeã€Queueã€Binding åŸºæœ¬æ¦‚å¿µ
2. **è¿›é˜¶**ï¼šæŒæ¡æ¶ˆæ¯ç¡®è®¤ã€æ­»ä¿¡é˜Ÿåˆ—ã€å»¶è¿Ÿé˜Ÿåˆ—
3. **é«˜çº§**ï¼šé›†ç¾¤éƒ¨ç½²ã€ä»²è£é˜Ÿåˆ—ã€æ€§èƒ½è°ƒä¼˜

---

> ğŸ“– æœ¬æ–‡æ¡£æŒç»­æ›´æ–°ï¼Œå¦‚æœ‰é—®é¢˜æ¬¢è¿è®¨è®ºï¼
