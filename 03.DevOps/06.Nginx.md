---
title: Nginx å®Œå…¨æŒ‡å—ï¼šä»åŸç†åˆ°å®æˆ˜
date: 2025-12-15
author: Eugen
tags:
  - Nginx
  - WebæœåŠ¡å™¨
  - åå‘ä»£ç†
  - è´Ÿè½½å‡è¡¡
  - DevOps
  - è¿ç»´å·¥å…·
---

# ğŸš€ Nginx å®Œå…¨æŒ‡å—ï¼šä»åŸç†åˆ°å®æˆ˜

> Nginxï¼ˆå‘éŸ³ "Engine X"ï¼‰æ˜¯äº’è”ç½‘ä¸–ç•Œçš„**æµé‡æ¢çº½**ã€‚ä½ åˆ·çš„æŠ–éŸ³ã€çœ‹çš„Bç«™ã€é€›çš„æ·˜å®ï¼ŒèƒŒåéƒ½æœ‰å®ƒåœ¨é»˜é»˜è½¬å‘è¯·æ±‚ã€‚æœ¬æ–‡å°†ç”¨é€šä¿—çš„è¯­è¨€é…åˆç¡¬æ ¸çš„é…ç½®ï¼Œå¸¦ä½ å½»åº•æ‹¿ä¸‹ Nginxã€‚

---

## ä¸€ã€ğŸ£ å®ƒæ˜¯è°ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨å®ƒï¼Ÿ

### 1.1 æ ¸å¿ƒè§’è‰²ï¼šç«é”…åº—çš„"è¶…çº§å‰å°"

æƒ³è±¡ä½ å¼€äº†ä¸€å®¶è¶…çº§ç«çˆ†çš„ç«é”…åº—ï¼ˆ**åç«¯æœåŠ¡å™¨**ï¼‰ï¼Œå¦‚æœé¡¾å®¢ç›´æ¥å†²è¿›å¨æˆ¿æ‰¾å¨å¸ˆï¼ˆTomcat/Node.jsï¼‰ç‚¹èœï¼Œå¨æˆ¿ä¸€å®šä¹±æˆä¸€é”…ç²¥ã€‚

è¿™æ—¶å€™ï¼Œä½ é›‡ä½£äº† **Nginx** ç«™åœ¨å¤§é—¨å£ï¼š

| è§’è‰² | èŒè´£ | æŠ€æœ¯å¯¹åº” |
|:---|:---|:---|
| ğŸ›¡ï¸ **ä¿é•–** | é¡¾å®¢åªè®¤è¯†å‰å°ï¼Œä¸çŸ¥é“å¨æˆ¿åé—¨åœ¨å“ª | åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰ |
| ğŸ“‹ **è°ƒåº¦å‘˜** | Aå¨å¸ˆå¿™ç–¯äº†ï¼ŒæŠŠæ–°è®¢å•é€’ç»™æ‘¸é±¼çš„Bå¨å¸ˆ | è´Ÿè½½å‡è¡¡ï¼ˆLoad Balancingï¼‰ |
| ğŸ§Š **æ•ˆç‡ä¸“å®¶** | é¡¾å®¢è¦ç“¶å¯ä¹ï¼Œç›´æ¥ä»å‰å°å†°æŸœæ‹¿ï¼Œä¸éº»çƒ¦å¨å¸ˆ | åŠ¨é™åˆ†ç¦»ï¼ˆStatic/Dynamic Separationï¼‰ |

### 1.2 ä¸ºä»€ä¹ˆ Nginx è¿™ä¹ˆå¿«ï¼Ÿ

Nginx é‡‡ç”¨**äº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥éé˜»å¡æ¶æ„**ï¼Œæ ¸å¿ƒæŠ€æœ¯æ˜¯ **å¤šè·¯å¤ç”¨ï¼ˆEpollï¼‰**ï¼š

- **ä¼ ç»ŸæœåŠ¡å™¨ï¼ˆApacheï¼‰**ï¼šæ¥ä¸€ä¸ªå®¢äººæ´¾ä¸€ä¸ªæœåŠ¡å‘˜ç›¯ç€ï¼Œäººå¤šäº†æœåŠ¡å‘˜ä¸å¤Ÿç”¨ â†’ è¿›ç¨‹/çº¿ç¨‹æ¨¡å‹
- **Nginx**ï¼šä¸€ä¸ªæœåŠ¡å‘˜ç›¯ç€å…¨åœºï¼Œè°ä¸¾æ‰‹å°±å¤„ç†è°ï¼Œå¤„ç†å®Œç«‹åˆ»ç›¯ä¸‹ä¸€ä¸ª â†’ äº‹ä»¶é©±åŠ¨æ¨¡å‹

> ğŸ’¡ **ä¸€å¥è¯æ€»ç»“**ï¼šå°±åœ¨ä½ çœ¨çœ¼çš„ä¸€ç¬é—´ï¼ŒNginx èƒ½å¤„ç†ä¸Šä¸‡ä¸ªå¹¶å‘è¿æ¥ï¼ŒåŒæ—¶å†…å­˜å ç”¨æä½ã€‚

### 1.3 ä¸»è¦åº”ç”¨åœºæ™¯

1. **WebæœåŠ¡å™¨**ï¼šç›´æ¥æä¾› HTTP æœåŠ¡
2. **åå‘ä»£ç†**ï¼šéšè—åç«¯æœåŠ¡å™¨ï¼Œæä¾›ç»Ÿä¸€å…¥å£
3. **è´Ÿè½½å‡è¡¡**ï¼šåˆ†å‘è¯·æ±‚åˆ°å¤šä¸ªåç«¯æœåŠ¡å™¨
4. **é™æ€èµ„æºæœåŠ¡**ï¼šé«˜æ•ˆå¤„ç†å›¾ç‰‡ã€CSSã€JS ç­‰é™æ€æ–‡ä»¶
5. **APIç½‘å…³**ï¼šå¾®æœåŠ¡æ¶æ„çš„ç»Ÿä¸€å…¥å£
6. **SSLç»ˆç«¯**ï¼šå¤„ç† HTTPS åŠ å¯†å’Œè§£å¯†
7. **TCP/UDPä»£ç†**ï¼šæ•°æ®åº“ã€Redis ç­‰å››å±‚è½¬å‘

---

## äºŒã€ğŸ—ï¸ å®‰è£… Nginx

### 2.1 åŒ…ç®¡ç†å™¨å®‰è£…ï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
# Ubuntu/Debian
sudo apt update && sudo apt install -y nginx
sudo systemctl start nginx && sudo systemctl enable nginx

# CentOS/RHEL
sudo yum install -y epel-release && sudo yum install -y nginx
sudo systemctl start nginx && sudo systemctl enable nginx
```

### 2.2 æºç ç¼–è¯‘å®‰è£…ï¼ˆéœ€è¦è‡ªå®šä¹‰æ¨¡å—æ—¶ï¼‰

å½“ä½ éœ€è¦æ·»åŠ ç¬¬ä¸‰æ–¹æ¨¡å—ï¼ˆå¦‚ Brotli å‹ç¼©ã€ç¼“å­˜æ¸…ç†æ¨¡å—ï¼‰æ—¶ï¼Œå¿…é¡»ä»æºç ç¼–è¯‘ï¼š

```bash
# 1. å®‰è£…ç¼–è¯‘ä¾èµ–
sudo apt install -y build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev

# 2. ä¸‹è½½å¹¶è§£å‹æºç 
wget http://nginx.org/download/nginx-1.24.0.tar.gz
tar -xzf nginx-1.24.0.tar.gz && cd nginx-1.24.0

# 3. é…ç½®ç¼–è¯‘é€‰é¡¹ï¼ˆå…³é”®æ­¥éª¤ï¼‰
./configure \
    --prefix=/usr/local/nginx \
    --with-http_ssl_module \          # HTTPS æ”¯æŒ
    --with-stream \                   # TCP/UDP å››å±‚è½¬å‘
    --with-http_stub_status_module \  # çŠ¶æ€ç›‘æ§é¡µé¢
    --add-module=/path/to/module      # æ·»åŠ ç¬¬ä¸‰æ–¹æ¨¡å—

# 4. ç¼–è¯‘å¹¶å®‰è£…
make && sudo make install
```

> ğŸ›‘ **ç¼–è¯‘æŠ¥é”™ï¼Ÿ** é€šå¸¸æ˜¯ç¬¬1æ­¥çš„ä¾èµ–åº“æ²¡è£…å¥½ï¼Œä»”ç»†æ£€æŸ¥æŠ¥é”™ä¿¡æ¯ã€‚

---

## ä¸‰ã€ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„ï¼šæ´‹è‘±å¼å±‚çº§

Nginx é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸åœ¨ `/etc/nginx/nginx.conf`ï¼‰ç»“æ„ä¸¥è°¨ï¼Œåƒæ´‹è‘±ä¸€æ ·ä¸€å±‚åŒ…ä¸€å±‚ã€‚

### 3.1 å…¨å±€ç»“æ„å›¾è§£

```nginx
# ==================== 1. Main å…¨å±€å— ====================
user nginx;                    # è¿è¡Œèº«ä»½
worker_processes auto;         # å·¥ä½œè¿›ç¨‹æ•°ï¼Œå»ºè®®è®¾ä¸º CPU æ ¸æ•°
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# ==================== 2. Events å— ====================
events {
    worker_connections 1024;   # æ¯ä¸ªè¿›ç¨‹æœ€å¤§è¿æ¥æ•°
    use epoll;                 # Linux ç³»ç»Ÿæ¨è
}

# ==================== 3. HTTP å—ï¼ˆä¸ƒå±‚ï¼‰ ====================
http {
    include mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼å®šä¹‰
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent"';

    # æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    keepalive_timeout 65;
    gzip on;

    # ğŸ’¡ æœ€ä½³å®è·µï¼šæ¨¡å—åŒ–ç®¡ç†ï¼Œä¸è¦æŠŠæ‰€æœ‰é…ç½®å¡åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œ
    include /etc/nginx/conf.d/*.conf;

    # Server å—å®šä¹‰å…·ä½“ç½‘ç«™
    server {
        listen 80;
        server_name example.com;
        # ...
    }
}

# ==================== 4. Stream å—ï¼ˆå››å±‚ï¼‰ ====================
# âš ï¸ æ³¨æ„ï¼šå®ƒå’Œ http å—æ˜¯å¹³çº§çš„ï¼ä¸è¦å†™åˆ° http é‡Œé¢ï¼
stream {
    # TCP/UDP è½¬å‘é…ç½®
}
```

> ğŸ›‘ **å°ç™½å¸¸è§å‘**ï¼šåœ¨ `conf.d/my_site.conf` é‡Œï¼Œ**ä¸è¦**å†å†™ `http { ... }` åŒ…è£¹ `server`ï¼å› ä¸ºä¸»é…ç½®å·²ç»æœ‰äº† `http`ï¼Œ`include` åªæ˜¯æŠŠå†…å®¹"å¸å…¥"è¿›å»ï¼Œå†å†™ä¸€éä¼šæŠ¥åµŒå¥—é”™è¯¯ã€‚

### 3.2 é…ç½®æ–‡ä»¶ç®¡ç†æœ€ä½³å®è·µ

```
/etc/nginx/
â”œâ”€â”€ nginx.conf              # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ mime.types              # MIME ç±»å‹å®šä¹‰
â”œâ”€â”€ conf.d/                 # é€šç”¨é…ç½®
â”‚   â”œâ”€â”€ gzip.conf           # å‹ç¼©é…ç½®
â”‚   â”œâ”€â”€ proxy.conf          # ä»£ç†é€šç”¨é…ç½®
â”‚   â””â”€â”€ security.conf       # å®‰å…¨å¤´é…ç½®
â”œâ”€â”€ sites-available/        # æ‰€æœ‰ç«™ç‚¹é…ç½®
â”‚   â”œâ”€â”€ api.example.com.conf
â”‚   â””â”€â”€ www.example.com.conf
â””â”€â”€ sites-enabled/          # å·²å¯ç”¨ç«™ç‚¹ï¼ˆç¬¦å·é“¾æ¥ï¼‰
    â””â”€â”€ api.example.com.conf -> ../sites-available/api.example.com.conf
```

```bash
# å¯ç”¨/ç¦ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/mysite.conf /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/mysite.conf

# æµ‹è¯•å¹¶é‡è½½é…ç½®
sudo nginx -t && sudo nginx -s reload
```

---

## å››ã€ğŸ¯ Location åŒ¹é…è§„åˆ™ï¼ˆå¿…è€ƒé¢˜ï¼‰

è¿™æ˜¯ Nginx æœ€è®©äººå¤´ç§ƒçš„åœ°æ–¹ã€‚è¯·æ­»è®°ç¡¬èƒŒä»¥ä¸‹å£è¯€ï¼š

> ğŸ¯ **"ç²¾ç¡®æœ€è´µï¼Œå‰ç¼€é”å®šéšåï¼Œæ­£åˆ™çœ‹é¡ºåºï¼Œæ™®é€šå‰ç¼€æ˜¯å¤‡èƒã€‚"**

### 4.1 åŒ¹é…ç¬¦å·ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ç¬¦å· | åç§° | è¯´æ˜ |
|:---:|:---|:---|:---|
| 1ï¸âƒ£ | `=` | ç²¾ç¡®åŒ¹é… | å®Œå…¨ä¸€æ¨¡ä¸€æ ·æ‰è¡Œï¼ŒåŒ¹é…åç«‹å³åœæ­¢ |
| 2ï¸âƒ£ | `^~` | å‰ç¼€é”å®š | åŒ¹é…ä¸Šè¿™ä¸ªå‰ç¼€ï¼Œå°±**ä¸å†çœ‹æ­£åˆ™** |
| 3ï¸âƒ£ | `~` / `~*` | æ­£åˆ™åŒ¹é… | `~` åŒºåˆ†å¤§å°å†™ï¼Œ`~*` ä¸åŒºåˆ† |
| 4ï¸âƒ£ | `/xxx` | æ™®é€šå‰ç¼€ | æ‰€æœ‰éƒ½åŒ¹é…ä¸ä¸Šæ—¶çš„å…œåº• |

### 4.2 å®æˆ˜æ¡ˆä¾‹åˆ†æ

```nginx
location = /images/logo.png { return 200 "A: ç²¾ç¡®"; }
location ^~ /images/        { return 200 "B: å‰ç¼€é”å®š"; }
location ~ /images/.*\.png$ { return 200 "C: æ­£åˆ™"; }
location /images/           { return 200 "D: æ™®é€šå‰ç¼€"; }
```

| è¯·æ±‚è·¯å¾„ | å‘½ä¸­ | åŸå›  |
|:---|:---:|:---|
| `/images/logo.png` | A | `=` ç²¾ç¡®åŒ¹é…ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œç›´æ¥ç»“æŸ |
| `/images/avatar.png` | B | æ»¡è¶³ B çš„ `^~` å‰ç¼€é”å®šï¼Œ**å¿½ç•¥** C æ­£åˆ™ |
| `/images/test.jpg` | B | åŒä¸Šï¼Œ`^~` é˜»æ­¢äº†æ­£åˆ™åŒ¹é… |

å¦‚æœæŠŠ B æ”¹æˆæ™®é€šå‰ç¼€ï¼ˆå»æ‰ `^~`ï¼‰ï¼š

```nginx
location /images/ { return 200 "B: æ™®é€šå‰ç¼€"; }
```

| è¯·æ±‚è·¯å¾„ | å‘½ä¸­ | åŸå›  |
|:---|:---:|:---|
| `/images/avatar.png` | C | B æ˜¯æ™®é€šå‰ç¼€ï¼Œå­˜ä¸º"å¤‡èƒ"ï¼›C æ­£åˆ™åŒ¹é…æˆåŠŸï¼Œæ­£åˆ™ä¼˜å…ˆ |

### 4.3 åŠ¨é™åˆ†ç¦»æ ‡å‡†å†™æ³•

```nginx
server {
    listen 80;
    server_name example.com;

    # 1. é™æ€æ–‡ä»¶ä¼˜å…ˆå¤„ç†ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰
    location ~ .*\.(gif|jpg|jpeg|png|css|js|ico)$ {
        root /var/www/static;
        expires 30d;  # å®¢æˆ·ç«¯ç¼“å­˜30å¤©
        add_header Cache-Control "public, immutable";
    }

    # 2. å…¶ä»–è¯·æ±‚è½¬å‘ç»™åç«¯
    location / {
        proxy_pass http://backend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## äº”ã€âš–ï¸ è´Ÿè½½å‡è¡¡è¯¦è§£

å½“ä½ æœ‰ä¸¤å°ä»¥ä¸ŠæœåŠ¡å™¨æ—¶ï¼ŒNginx çš„é­”åŠ›å°±ä½“ç°å‡ºæ¥äº†ã€‚é€šè¿‡ `upstream` æ¨¡å—å®šä¹‰åç«¯æœåŠ¡å™¨ç»„ã€‚

### 5.1 å››ç§è´Ÿè½½å‡è¡¡ç­–ç•¥

```nginx
# ç­–ç•¥1ï¼šè½®è¯¢ï¼ˆé»˜è®¤ï¼‰- ç»å¯¹å…¬å¹³ï¼Œä¾æ¬¡åˆ†é…
upstream backend {
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
}

# ç­–ç•¥2ï¼šåŠ æƒè½®è¯¢ - èƒ½è€…å¤šåŠ³
upstream backend {
    server 192.168.1.101:8080 weight=1;  # æ—§æœåŠ¡å™¨ï¼Œæ¥1ä¸ª
    server 192.168.1.102:8080 weight=5;  # æ–°æœåŠ¡å™¨ï¼Œæ¥5ä¸ª
}

# ç­–ç•¥3ï¼šIP Hash - ä¼šè¯ä¿æŒ
# åŒä¸€IPæ°¸è¿œåˆ†ç»™åŒä¸€å°æœºå™¨ï¼Œè§£å†³ session ä¸å…±äº«é—®é¢˜
upstream backend {
    ip_hash;
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
}

# ç­–ç•¥4ï¼šæœ€å°‘è¿æ¥ - ä¼˜å…ˆåˆ†ç»™æœ€é—²çš„
upstream backend {
    least_conn;
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
}
```

### 5.2 å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»

```nginx
upstream backend {
    server 192.168.1.101:8080 max_fails=3 fail_timeout=30s;  # å¤±è´¥3æ¬¡åï¼Œ30ç§’å†…ä¸å†åˆ†é…
    server 192.168.1.102:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.103:8080 backup;  # ğŸš‘ å¤‡ç”¨æœåŠ¡å™¨ï¼Œåªæœ‰ä¸Šé¢éƒ½æŒ‚äº†æ‰å¯ç”¨
    server 192.168.1.104:8080 down;    # ğŸ”´ æ ‡è®°ä¸‹çº¿ï¼Œä¸å‚ä¸åˆ†é…
}
```

### 5.3 å®Œæ•´åå‘ä»£ç†é…ç½®

```nginx
upstream backend_api {
    least_conn;
    server 192.168.1.10:8080 weight=3 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 weight=2 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 backup;
}

server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://backend_api;

        # å¿…è¦çš„ä»£ç†å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # ç¼“å†²è®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
}
```

### 5.4 ä»£ç†å¤´è¯¦è§£

å½“ Nginx ä½œä¸ºåå‘ä»£ç†æ—¶ï¼Œåç«¯æœåŠ¡é»˜è®¤åªèƒ½çœ‹åˆ° Nginx çš„ IPï¼Œéœ€è¦é€šè¿‡ HTTP å¤´ä¼ é€’åŸå§‹å®¢æˆ·ç«¯ä¿¡æ¯ã€‚

#### å¸¸ç”¨ä»£ç†å¤´ä¸€è§ˆ

| å¤´åç§° | å¯¹åº”å˜é‡ | ä½œç”¨ |
|:---|:---|:---|
| `Host` | `$host` | ä¼ é€’åŸå§‹è¯·æ±‚çš„åŸŸå |
| `X-Real-IP` | `$remote_addr` | ä¼ é€’ç›´æ¥è¿æ¥åˆ° Nginx çš„å®¢æˆ·ç«¯ IP |
| `X-Forwarded-For` | `$proxy_add_x_forwarded_for` | è®°å½•å®Œæ•´çš„ä»£ç†é“¾ IP åˆ—è¡¨ |
| `X-Forwarded-Proto` | `$scheme` | ä¼ é€’åŸå§‹è¯·æ±‚åè®®ï¼ˆhttp/httpsï¼‰ |
| `X-Forwarded-Port` | `$server_port` | ä¼ é€’åŸå§‹è¯·æ±‚ç«¯å£ |
| `X-Forwarded-Host` | `$host` | ä¼ é€’åŸå§‹ Hostï¼ˆæŸäº›æ¡†æ¶éœ€è¦ï¼‰ |

#### å„å¤´è¯¦ç»†è¯´æ˜

**1ï¸âƒ£ Host**

```nginx
proxy_set_header Host $host;
```

- å‘Šè¯‰åç«¯"ç”¨æˆ·è®¿é—®çš„æ˜¯å“ªä¸ªåŸŸå"
- å¸¸è§å˜é‡å¯¹æ¯”ï¼š
  - `$host`ï¼šè¯·æ±‚å¤´ä¸­çš„ Hostï¼Œæˆ–åŒ¹é…çš„ server_nameï¼ˆ**æ¨è**ï¼‰
  - `$http_host`ï¼šå®Œæ•´çš„ Host å¤´ï¼ŒåŒ…å«ç«¯å£ï¼ˆå¦‚ `example.com:8080`ï¼‰
  - `$proxy_host`ï¼š`proxy_pass` ä¸­çš„åœ°å€ï¼ˆé»˜è®¤å€¼ï¼Œä¸€èˆ¬ä¸ç”¨ï¼‰

**2ï¸âƒ£ X-Real-IP**

```nginx
proxy_set_header X-Real-IP $remote_addr;
```

- ä¼ é€’ç›´æ¥è¿æ¥åˆ° Nginx çš„å®¢æˆ·ç«¯ IP
- å€¼æ˜¯**å•ä¸ª IP åœ°å€**
- é€‚ç”¨äºåªæœ‰ä¸€å±‚ä»£ç†çš„åœºæ™¯

**3ï¸âƒ£ X-Forwarded-Forï¼ˆé‡ç‚¹ï¼‰**

```nginx
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
```

- è®°å½•å®Œæ•´çš„ä»£ç†é“¾ï¼Œæ ¼å¼ï¼š`å®¢æˆ·ç«¯IP, ä»£ç†1IP, ä»£ç†2IP, ...`
- `$proxy_add_x_forwarded_for` = å·²æœ‰çš„ `X-Forwarded-For` + `, ` + `$remote_addr`
- å¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰è¯¥å¤´ï¼Œåˆ™ç­‰äº `$remote_addr`

**å¤šå±‚ä»£ç†ç¤ºä¾‹**ï¼š
```
å®¢æˆ·ç«¯(1.1.1.1) â†’ CDN(2.2.2.2) â†’ Nginx(3.3.3.3) â†’ åç«¯
# åç«¯æ”¶åˆ°: X-Forwarded-For: 1.1.1.1, 2.2.2.2
```

**4ï¸âƒ£ X-Forwarded-Proto**

```nginx
proxy_set_header X-Forwarded-Proto $scheme;
```

- å‘ŠçŸ¥åç«¯åŸå§‹è¯·æ±‚ä½¿ç”¨çš„åè®®ï¼ˆ`http` æˆ– `https`ï¼‰
- ç”¨é€”ï¼šåç«¯ç”Ÿæˆæ­£ç¡®çš„é‡å®šå‘ URLã€è®¾ç½®å®‰å…¨ Cookie ç­‰

#### å¯å¤ç”¨çš„ä»£ç†é…ç½®æ¨¡æ¿

å»ºè®®å°†é€šç”¨é…ç½®æŠ½å–ä¸ºå•ç‹¬æ–‡ä»¶ `/etc/nginx/conf.d/proxy_params`ï¼š

```nginx
# ä»£ç†å¤´
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-Port $server_port;
proxy_set_header X-Forwarded-Host $host;

# HTTP/1.1 é•¿è¿æ¥
proxy_http_version 1.1;
proxy_set_header Connection "";
```

ä½¿ç”¨æ—¶ç›´æ¥å¼•å…¥ï¼š

```nginx
location / {
    proxy_pass http://backend;
    include /etc/nginx/conf.d/proxy_params;
}
```

#### âš ï¸ å®‰å…¨è­¦å‘Šï¼šX-Forwarded-For å¯è¢«ä¼ªé€ 

å®¢æˆ·ç«¯å¯ä»¥ä¼ªé€  `X-Forwarded-For` å¤´æ¥æ¬ºéª—åç«¯ã€‚è§£å†³æ–¹æ¡ˆï¼š

```nginx
# æ–¹æ¡ˆ1ï¼šè¦†ç›–è€Œéè¿½åŠ ï¼ˆä¸¢å¼ƒå®¢æˆ·ç«¯å‘é€çš„å€¼ï¼‰
proxy_set_header X-Forwarded-For $remote_addr;

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨ real_ip æ¨¡å—å¤„ç†å¯ä¿¡ä»£ç†
set_real_ip_from 10.0.0.0/8;       # å†…ç½‘ä»£ç†
set_real_ip_from 172.16.0.0/12;
set_real_ip_from 192.168.0.0/16;
set_real_ip_from 103.21.244.0/22;  # Cloudflare CDN
real_ip_header X-Forwarded-For;
real_ip_recursive on;              # é€’å½’æŸ¥æ‰¾çœŸå® IP
```

#### åç«¯è·å–çœŸå® IP

**.NET Core**ï¼š

```csharp
// Program.cs
builder.Services.Configure<ForwardedHeadersOptions>(options =>
{
    options.ForwardedHeaders = ForwardedHeaders.XForwardedFor
                             | ForwardedHeaders.XForwardedProto;
    // ä¿¡ä»»çš„ä»£ç†ç½‘ç»œï¼ˆç”Ÿäº§ç¯å¢ƒåº”æ˜ç¡®æŒ‡å®šï¼‰
    options.KnownNetworks.Clear();
    options.KnownProxies.Clear();
});

app.UseForwardedHeaders();

// è·å–å®¢æˆ·ç«¯ IP
var clientIp = HttpContext.Connection.RemoteIpAddress;
```

**Node.js (Express)**ï¼š

```javascript
app.set('trust proxy', true);
// req.ip å°†è¿”å› X-Forwarded-For ä¸­çš„ç¬¬ä¸€ä¸ª IP
```

---

## å…­ã€ğŸŒ å››å±‚ vs ä¸ƒå±‚ä»£ç†

å¾ˆå¤šäººæä¸æ¸… Nginx èƒ½ä¸èƒ½è½¬å‘æ•°æ®åº“æˆ– TCP è¿æ¥ï¼Œç­”æ¡ˆæ˜¯ï¼š**èƒ½ï¼Œä½†é…ç½®ä½ç½®ä¸åŒ**ã€‚

### 6.1 æ ¸å¿ƒåŒºåˆ«

| ç»´åº¦ | Layer 7ï¼ˆåº”ç”¨å±‚ï¼‰ | Layer 4ï¼ˆä¼ è¾“å±‚ï¼‰ |
|:---|:---|:---|
| **å¤„ç†å¯¹è±¡** | HTTP å†…å®¹ï¼ˆURLã€Headerã€Cookieï¼‰ | TCP/UDP æ•°æ®åŒ…ï¼ˆIP + ç«¯å£ï¼‰ |
| **æ™ºèƒ½ç¨‹åº¦** | é«˜ï¼ˆèƒ½çœ‹æ‡‚ `/api` è¿˜æ˜¯ `/img`ï¼‰ | ä½ï¼ˆåªè´Ÿè´£æ¬è¿æ•°æ®æµï¼‰ |
| **æ€§èƒ½** | ç¨æ…¢ï¼ˆè¦æ‹†åŒ…çœ‹å†…å®¹ï¼‰ | æå¿«ï¼ˆç›´æ¥è½¬å‘ï¼‰ |
| **é…ç½®å—** | `http { ... }` | `stream { ... }` |
| **é€‚ç”¨åœºæ™¯** | Webåº”ç”¨ã€APIæœåŠ¡ | MySQLã€Redisã€è‡ªå®šä¹‰TCPåè®® |

### 6.2 ä¸ƒå±‚ä»£ç†ç¤ºä¾‹ï¼ˆHTTPï¼‰

```nginx
http {
    server {
        listen 80;
        server_name api.example.com;

        location / {
            proxy_pass http://127.0.0.1:3000;  # è½¬å‘ç»™ Node.js
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
```

### 6.3 å››å±‚ä»£ç†ç¤ºä¾‹ï¼ˆTCP/UDPï¼‰

```nginx
# âš ï¸ stream å—å¿…é¡»å’Œ http å—å¹³çº§ï¼
stream {
    # æ—¥å¿—æ ¼å¼ï¼ˆå››å±‚ä¸“ç”¨ï¼‰
    log_format tcp_log '$remote_addr [$time_local] $protocol $status '
                       '$bytes_sent $bytes_received $session_time';
    access_log /var/log/nginx/stream.access.log tcp_log;

    # MySQL è´Ÿè½½å‡è¡¡
    upstream mysql_cluster {
        least_conn;
        server 192.168.1.10:3306;
        server 192.168.1.11:3306;
    }

    server {
        listen 3306;              # Nginx ç›‘å¬ 3306
        proxy_pass mysql_cluster; # è½¬å‘ç»™å†…ç½‘æ•°æ®åº“
        proxy_connect_timeout 1s;
        proxy_timeout 3s;
    }

    # Redis è½¬å‘ï¼ˆä½¿ç”¨ IP Hash ä¿æŒè¿æ¥ä¸€è‡´æ€§ï¼‰
    upstream redis_cluster {
        hash $remote_addr consistent;
        server 192.168.1.20:6379;
        server 192.168.1.21:6379;
    }

    server {
        listen 6379;
        proxy_pass redis_cluster;
    }

    # UDP è½¬å‘ç¤ºä¾‹ï¼ˆDNSï¼‰
    upstream dns_servers {
        server 8.8.8.8:53;
        server 8.8.4.4:53;
    }

    server {
        listen 53 udp;
        proxy_pass dns_servers;
        proxy_timeout 1s;
        proxy_responses 1;
    }
}
```

### 6.4 SSL/TLS å¤„ç†

```nginx
# ä¸ƒå±‚ HTTPS ç»ˆæ­¢ï¼ˆNginx è§£å¯†ï¼Œåç«¯èµ° HTTPï¼‰
server {
    listen 443 ssl http2;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/example.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    location / {
        proxy_pass http://backend;  # åç«¯ä¸éœ€è¦å¤„ç† SSL
        proxy_set_header X-Forwarded-Proto https;
    }
}

# HTTP è‡ªåŠ¨è·³è½¬ HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}
```

---

## ä¸ƒã€ğŸ“ æ—¥å¿—é…ç½®

### 7.1 å¸¸ç”¨æ—¥å¿—å˜é‡

| å˜é‡ | è¯´æ˜ |
|:---|:---|
| `$remote_addr` | å®¢æˆ·ç«¯ IP |
| `$time_local` | æœ¬åœ°æ—¶é—´ |
| `$request` | å®Œæ•´è¯·æ±‚è¡Œ |
| `$status` | å“åº”çŠ¶æ€ç  |
| `$body_bytes_sent` | å“åº”ä½“å¤§å° |
| `$request_time` | è¯·æ±‚å¤„ç†æ—¶é—´ï¼ˆç§’ï¼‰ |
| `$upstream_response_time` | åç«¯å“åº”æ—¶é—´ |
| `$http_user_agent` | å®¢æˆ·ç«¯ User-Agent |

### 7.2 è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼

```nginx
http {
    # æ ‡å‡†æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent"';

    # è¯¦ç»†æ ¼å¼ï¼ˆåŒ…å«æ€§èƒ½æŒ‡æ ‡ï¼‰
    log_format detailed '$remote_addr [$time_local] "$request" '
                        '$status rt=$request_time '
                        'uct="$upstream_connect_time" '
                        'urt="$upstream_response_time"';

    # JSON æ ¼å¼ï¼ˆä¾¿äº ELK ç­‰æ—¥å¿—ç³»ç»Ÿè§£æï¼‰
    log_format json escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time"'
    '}';

    server {
        access_log /var/log/nginx/access.log main;
        # æˆ–ä½¿ç”¨ JSON æ ¼å¼
        # access_log /var/log/nginx/access.json json;
    }
}
```

### 7.3 æ¡ä»¶æ—¥å¿—ï¼ˆåªè®°å½•æ…¢è¯·æ±‚ï¼‰

```nginx
# åªè®°å½•å¤„ç†æ—¶é—´ > 1ç§’çš„è¯·æ±‚
map $request_time $loggable {
    ~^[0]\.[0-9]+$ 0;  # å°äº1ç§’ä¸è®°å½•
    default 1;
}

access_log /var/log/nginx/slow.log detailed if=$loggable;
```

---

## å…«ã€âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®

```nginx
# å…¨å±€ä¼˜åŒ–
user nginx;
worker_processes auto;              # è‡ªåŠ¨åŒ¹é… CPU æ ¸æ•°
worker_rlimit_nofile 65535;         # æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°

events {
    worker_connections 4096;        # æ¯ä¸ª worker æœ€å¤§è¿æ¥æ•°
    use epoll;                      # Linux é«˜æ€§èƒ½äº‹ä»¶æ¨¡å‹
    multi_accept on;                # ä¸€æ¬¡æ¥å—å¤šä¸ªè¿æ¥
}

http {
    # æ–‡ä»¶ä¼ è¾“ä¼˜åŒ–
    sendfile on;                    # é›¶æ‹·è´ä¼ è¾“
    tcp_nopush on;                  # ä¼˜åŒ–æ•°æ®åŒ…å‘é€
    tcp_nodelay on;                 # ç¦ç”¨ Nagle ç®—æ³•

    # è¿æ¥ä¼˜åŒ–
    keepalive_timeout 65;
    keepalive_requests 100;         # æ¯ä¸ªè¿æ¥æœ€å¤§è¯·æ±‚æ•°

    # æ–‡ä»¶ç¼“å­˜
    open_file_cache max=10000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/plain text/css application/json
               application/javascript text/xml application/xml
               image/svg+xml;

    # ç¼“å†²ä¼˜åŒ–
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
}
```

---

## ä¹ã€ğŸ”’ å®‰å…¨é…ç½®

```nginx
http {
    # éšè—ç‰ˆæœ¬å·
    server_tokens off;

    # å®‰å…¨å“åº”å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;          # é˜²æ­¢ç‚¹å‡»åŠ«æŒ
    add_header X-Content-Type-Options "nosniff" always;      # é˜²æ­¢ MIME å—…æ¢
    add_header X-XSS-Protection "1; mode=block" always;      # XSS é˜²æŠ¤
    add_header Referrer-Policy "no-referrer-when-downgrade"; # Referrer ç­–ç•¥

    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;   # åªå…è®¸å®‰å…¨åè®®
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # é™åˆ¶è¯·æ±‚å¤§å°
    client_max_body_size 10m;

    # é™åˆ¶è¯·æ±‚æ–¹æ³•
    if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) {
        return 405;
    }
}
```

---

## åã€ğŸ“Š çŠ¶æ€ç›‘æ§

```nginx
server {
    listen 8080;
    server_name localhost;

    location /nginx_status {
        stub_status on;       # å¯ç”¨çŠ¶æ€æ¨¡å—
        access_log off;       # ä¸è®°å½•è®¿é—®æ—¥å¿—
        allow 127.0.0.1;      # åªå…è®¸æœ¬æœºè®¿é—®
        allow 192.168.1.0/24; # å…è®¸å†…ç½‘è®¿é—®
        deny all;             # ç¦æ­¢å…¶ä»–è®¿é—®
    }
}
```

è®¿é—® `http://server:8080/nginx_status` å¯ä»¥çœ‹åˆ°ï¼š
- Active connectionsï¼šå½“å‰æ´»è·ƒè¿æ¥æ•°
- Server accepts/handled/requestsï¼šæ€»è¿æ¥æ•°/å¤„ç†æ•°/è¯·æ±‚æ•°
- Reading/Writing/Waitingï¼šè¯»å–/å†™å…¥/ç­‰å¾…çš„è¿æ¥æ•°

---

## åä¸€ã€ğŸ“œ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨

| å‘½ä»¤ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|:---|:---|:---|
| `nginx -t` | æ£€æŸ¥é…ç½®è¯­æ³• | æ¯æ¬¡æ”¹å®Œé…ç½®**å¿…æ•²** |
| `nginx -T` | æ˜¾ç¤ºå®Œæ•´é…ç½® | è°ƒè¯•æ—¶æŸ¥çœ‹æœ€ç»ˆé…ç½® |
| `nginx -s reload` | å¹³æ»‘é‡è½½é…ç½® | ä¸ä¸­æ–­æœåŠ¡ï¼Œæ–°é…ç½®ç”Ÿæ•ˆ |
| `nginx -s stop` | å¼ºåˆ¶åœæ­¢ | ç«‹å³åœæ­¢æ‰€æœ‰è¿æ¥ |
| `nginx -s quit` | ä¼˜é›…åœæ­¢ | å¤„ç†å®Œå½“å‰è¯·æ±‚å†åœæ­¢ |
| `nginx -V` | æŸ¥çœ‹ç‰ˆæœ¬å’Œç¼–è¯‘å‚æ•° | ç¡®è®¤å®‰è£…äº†å“ªäº›æ¨¡å— |
| `nginx` | å¯åŠ¨ Nginx | é¦–æ¬¡å¯åŠ¨ |

```bash
# å¸¸ç”¨è°ƒè¯•å‘½ä»¤
sudo nginx -t                        # æµ‹è¯•é…ç½®
sudo nginx -s reload                 # é‡è½½é…ç½®
ps aux | grep nginx                  # æŸ¥çœ‹è¿›ç¨‹
tail -f /var/log/nginx/error.log     # å®æ—¶æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/access.log    # å®æ—¶æŸ¥çœ‹è®¿é—®æ—¥å¿—
```

---

## åäºŒã€ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### 12.1 é…ç½®ä¸ç”Ÿæ•ˆ

```bash
# 1. æ£€æŸ¥é…ç½®è¯­æ³•
sudo nginx -t

# 2. ç¡®è®¤é‡è½½äº†é…ç½®
sudo nginx -s reload

# 3. æ£€æŸ¥æ˜¯å¦è¢«å…¶ä»– location æ‹¦æˆª
nginx -T | grep -A 10 "server_name your_domain"
```

### 12.2 502 Bad Gateway

```bash
# 1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://127.0.0.1:8080

# 2. æ£€æŸ¥ upstream é…ç½®çš„åœ°å€å’Œç«¯å£
# 3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log
```

### 12.3 æƒé™é—®é¢˜

```bash
# Nginx è¿è¡Œç”¨æˆ·éœ€è¦æœ‰è¯»å–é™æ€æ–‡ä»¶çš„æƒé™
sudo chown -R nginx:nginx /var/www/html
sudo chmod -R 755 /var/www/html
```

---

## åä¸‰ã€ğŸ•™ è¶…æ—¶æ—¶é—´é…ç½®

åœ¨ Nginx ä¸­ï¼Œä¿®æ”¹è¶…æ—¶æ—¶é—´å¯ä»¥åœ¨ **ä¸‰ä¸ªå±‚çº§** è¿›è¡Œé…ç½®ï¼Œå…·ä½“å–å†³äºä½ å¸Œæœ›é…ç½®ç”Ÿæ•ˆçš„èŒƒå›´ã€‚

è¿™ä¸‰ä¸ªå±‚çº§åˆ†åˆ«æ˜¯ï¼š

1.  **`http` å±‚çº§**ï¼ˆå…¨å±€ç”Ÿæ•ˆï¼‰
2.  **`server` å±‚çº§**ï¼ˆç‰¹å®šè™šæ‹Ÿä¸»æœºç”Ÿæ•ˆï¼‰
3.  **`location` å±‚çº§**ï¼ˆç‰¹å®š URL è·¯å¾„ç”Ÿæ•ˆï¼‰

ä¼˜å…ˆçº§è§„åˆ™æ˜¯ï¼š**å±‚çº§è¶Šæ·±ï¼Œä¼˜å…ˆçº§è¶Šé«˜**ï¼ˆLocation > Server > Httpï¼‰ã€‚å¦‚æœæ²¡æœ‰åœ¨æ·±å±‚çº§é…ç½®ï¼Œå®ƒä¼šç»§æ‰¿ä¸Šä¸€å±‚çº§çš„é…ç½®ã€‚

---

### 1. å¸¸è§çš„è¶…æ—¶å‚æ•°åŠå…¶ä½œç”¨

åœ¨ä¿®æ”¹ä¹‹å‰ï¼Œä½ éœ€è¦æ˜ç¡®ä½ æƒ³ä¿®æ”¹å“ªç§è¶…æ—¶æ—¶é—´ã€‚æœ€å¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ç±»ï¼š

*   **å®¢æˆ·ç«¯ç›¸å…³ï¼š**
    *   `keepalive_timeout`: é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæœ€å¸¸ç”¨ï¼‰ã€‚
    *   `client_header_timeout`: è¯»å–å®¢æˆ·ç«¯è¯·æ±‚å¤´çš„è¶…æ—¶æ—¶é—´ã€‚
    *   `client_body_timeout`: è¯»å–å®¢æˆ·ç«¯è¯·æ±‚ä½“çš„è¶…æ—¶æ—¶é—´ã€‚
    *   `send_timeout`: å‘å®¢æˆ·ç«¯å‘é€å“åº”çš„è¶…æ—¶æ—¶é—´ã€‚

*   **åå‘ä»£ç†ç›¸å…³ï¼ˆå¦‚æœä½ ç”¨ Nginx åšåå‘ä»£ç†ï¼‰ï¼š**
    *   `proxy_connect_timeout`: è¿æ¥åç«¯æœåŠ¡å™¨çš„è¶…æ—¶æ—¶é—´ã€‚
    *   `proxy_read_timeout`: ç­‰å¾…åç«¯æœåŠ¡å™¨å“åº”ï¼ˆè¯»å–æ•°æ®ï¼‰çš„è¶…æ—¶æ—¶é—´ï¼ˆæœ€å¸¸ç”¨ï¼Œè§£å†³ 504 Gateway Time-outï¼‰ã€‚
    *   `proxy_send_timeout`: å‘åç«¯æœåŠ¡å™¨å‘é€æ•°æ®çš„è¶…æ—¶æ—¶é—´ã€‚

---

### 2. é…ç½®ç¤ºä¾‹

#### æ–¹æ¡ˆ Aï¼šåœ¨ `http` å±‚çº§ä¿®æ”¹ï¼ˆå…¨å±€ç”Ÿæ•ˆï¼‰
ä¿®æ”¹ `nginx.conf` æ–‡ä»¶ã€‚è¿™ä¼šå½±å“è¯¥ Nginx å®ä¾‹ä¸‹çš„æ‰€æœ‰ç½‘ç«™ã€‚

```nginx
http {
    include       mime.types;
    default_type  application/octet-stream;

    # --- å…¨å±€è¶…æ—¶è®¾ç½® ---
    keepalive_timeout  65;
    client_header_timeout 15s;
    client_body_timeout 15s;
    send_timeout 15s;
    
    # åå‘ä»£ç†å…¨å±€è¶…æ—¶
    proxy_connect_timeout 60s;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;

    server {
        ...
    }
}
```

#### æ–¹æ¡ˆ Bï¼šåœ¨ `server` å±‚çº§ä¿®æ”¹ï¼ˆé’ˆå¯¹æŸä¸ªåŸŸåï¼‰
åªå¯¹ç‰¹å®šçš„ç½‘ç«™ï¼ˆåŸŸåï¼‰ç”Ÿæ•ˆï¼Œä¸å½±å“å…¶ä»–ç½‘ç«™ã€‚

```nginx
server {
    listen       80;
    server_name  example.com;

    # --- ä»…å¯¹è¯¥ç«™ç‚¹ç”Ÿæ•ˆ ---
    keepalive_timeout 300; 
    proxy_read_timeout 300; 

    location / {
        root   html;
        index  index.html index.htm;
    }
}
```

#### æ–¹æ¡ˆ Cï¼šåœ¨ `location` å±‚çº§ä¿®æ”¹ï¼ˆé’ˆå¯¹ç‰¹å®šæ¥å£æˆ–è·¯å¾„ï¼‰
è¿™æ˜¯æœ€ç²¾ç»†çš„æ§åˆ¶ã€‚ä¾‹å¦‚ï¼Œä½ çš„ç½‘ç«™å¤§éƒ¨åˆ†æ¥å£å¾ˆå¿«ï¼Œä½†æœ‰ä¸€ä¸ª `/upload` æ¥å£ä¸Šä¼ æ–‡ä»¶å¾ˆæ…¢ï¼Œæˆ–è€… `/api/long-task` éœ€è¦è·‘å¾ˆä¹…ï¼Œä½ å¯ä»¥åªé’ˆå¯¹è¿™ä¸ªè·¯å¾„æ”¾å®½è¶…æ—¶æ—¶é—´ã€‚

```nginx
server {
    listen       80;
    server_name  example.com;

    location / {
        # ä½¿ç”¨é»˜è®¤æˆ– server çº§çš„é…ç½®
        proxy_pass http://backend;
    }

    # --- ä»…å¯¹ /long-task è·¯å¾„ç”Ÿæ•ˆ ---
    location /api/long-task {
        proxy_connect_timeout 600s;
        proxy_read_timeout 600s;  # å…è®¸åç«¯å¤„ç† 10 åˆ†é’Ÿ
        proxy_send_timeout 600s;
        proxy_pass http://backend;
    }
}
```

### æ€»ç»“
*   å¦‚æœæ‰€æœ‰ç½‘ç«™éƒ½éœ€è¦è°ƒæ•´ï¼Œæ”¹ **`http`** å±‚ã€‚
*   å¦‚æœåªæ˜¯æŸä¸ªç½‘ç«™éœ€è¦è°ƒæ•´ï¼Œæ”¹ **`server`** å±‚ã€‚
*   å¦‚æœæ˜¯æŸä¸ªå…·ä½“ä¸šåŠ¡æ¥å£æŠ¥è¶…æ—¶ï¼ˆå¦‚å¯¼å‡ºæŠ¥è¡¨ã€å¤§æ–‡ä»¶ä¸Šä¼ ï¼‰ï¼Œæ”¹ **`location`** å±‚ã€‚

**æ³¨æ„ï¼š** ä¿®æ”¹é…ç½®æ–‡ä»¶åï¼Œåˆ«å¿˜äº†æµ‹è¯•é…ç½®å¹¶é‡è½½ Nginxï¼š
```bash
nginx -t
nginx -s reload
```

---

## ğŸ“š æ€»ç»“

Nginx å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆå¯æ€•ï¼š

1. ğŸ  æŠŠå®ƒå½“æˆä¸€ä¸ª**åˆ†å‘è¯·æ±‚çš„å‰å°**
2. ğŸ“¦ é…ç½®æ–‡ä»¶çš„æ ¸å¿ƒå°±æ˜¯ `http`ï¼ˆWebï¼‰å’Œ `stream`ï¼ˆTCPï¼‰
3. âš–ï¸ ææ‡‚ `upstream` åšè´Ÿè½½å‡è¡¡
4. ğŸ¯ ææ‡‚ `location` çš„ä¼˜å…ˆçº§é€»è¾‘ï¼ˆç²¾ç¡® > å‰ç¼€é”å®š > æ­£åˆ™ > æ™®é€šå‰ç¼€ï¼‰
5. ğŸ”§ è®°ä½ `nginx -t` å’Œ `nginx -s reload`

æŒæ¡è¿™äº›æ ¸å¿ƒæ¦‚å¿µå’Œé…ç½®ï¼Œä½ å°±èƒ½æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„ Web æœåŠ¡æ¶æ„äº†ã€‚

ç°åœ¨ï¼Œå»ä½ çš„æœåŠ¡å™¨ä¸Šæ•²ä¸‹ `nginx -t`ï¼Œå¼€å§‹ä½ çš„è¡¨æ¼”å§ï¼ğŸ‰
