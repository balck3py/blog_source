---
title: WebAssembly æŠ€æœ¯è¯¦è§£
date: 2024-12-17
author: Eugen
tags:
  - WebAssembly
  - WASM
  - å‰ç«¯æ€§èƒ½
  - äºŒè¿›åˆ¶æ ¼å¼
  - é«˜æ€§èƒ½è®¡ç®—
  - å¤šè¯­è¨€æ”¯æŒ
  - å›¾åƒå¤„ç†
  - Rust
  - AssemblyScript
  - å‰ç«¯ä¼˜åŒ–
---

# âš¡ WebAssembly æŠ€æœ¯è¯¦è§£

> æœ¬æ–‡å…¨é¢ä»‹ç» WebAssemblyï¼ˆWASMï¼‰æŠ€æœ¯ï¼Œä»å†å²èƒŒæ™¯åˆ°å®é™…åº”ç”¨ï¼Œå¸®åŠ©ä½ ç†è§£è¿™é¡¹è®© Web åº”ç”¨æ€§èƒ½æå‡ 10-100 å€çš„å‰æ²¿æŠ€æœ¯ã€‚æ— è®ºä½ æ˜¯å‰ç«¯å¼€å‘è€…è¿˜æ˜¯å¯¹é«˜æ€§èƒ½è®¡ç®—æ„Ÿå…´è¶£ï¼Œéƒ½èƒ½ä»ä¸­è·å¾—å®ç”¨çš„çŸ¥è¯†å’Œä»£ç ç¤ºä¾‹ã€‚

---

## ğŸ“š ç›®å½•
- [èƒŒæ™¯](#èƒŒæ™¯)
- [ä»€ä¹ˆæ˜¯ WebAssembly](#ä»€ä¹ˆæ˜¯-webassembly)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [ä½œç”¨ä¸åº”ç”¨åœºæ™¯](#ä½œç”¨ä¸åº”ç”¨åœºæ™¯)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
- [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)
- [æ€»ç»“](#æ€»ç»“)

---

## èƒŒæ™¯

### å†å²æ¼”è¿›

WebAssemblyï¼ˆç®€ç§° WASMï¼‰çš„è¯ç”Ÿæºäº Web å¹³å°å¯¹é«˜æ€§èƒ½è®¡ç®—çš„è¿«åˆ‡éœ€æ±‚ï¼š

1. **JavaScript çš„æ€§èƒ½ç“¶é¢ˆ**
   - JavaScript ä½œä¸ºè§£é‡Šå‹è¯­è¨€ï¼Œè™½ç„¶ç»è¿‡ JITï¼ˆå³æ—¶ç¼–è¯‘ï¼‰ä¼˜åŒ–ï¼Œä½†åœ¨è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¸Šä»å­˜åœ¨æ€§èƒ½é™åˆ¶
   - å¯¹äºå›¾åƒå¤„ç†ã€è§†é¢‘ç¼–è§£ç ã€3D æ¸²æŸ“ã€ç§‘å­¦è®¡ç®—ç­‰åœºæ™¯ï¼Œçº¯ JavaScript éš¾ä»¥æ»¡è¶³æ€§èƒ½è¦æ±‚

2. **ç°æœ‰è§£å†³æ–¹æ¡ˆçš„å±€é™æ€§**
   - **asm.js**ï¼šé€šè¿‡ JavaScript å­é›†å®ç°æ¥è¿‘åŸç”Ÿæ€§èƒ½ï¼Œä½†ä»ç„¶æ˜¯ JavaScriptï¼Œè§£æå’Œæ‰§è¡Œå¼€é”€è¾ƒå¤§
   - **Native Client (NaCl)**ï¼šGoogle çš„æ–¹æ¡ˆï¼Œä½†éœ€è¦æµè§ˆå™¨æ’ä»¶ï¼Œå…¼å®¹æ€§å’Œå®‰å…¨æ€§å­˜åœ¨é—®é¢˜
   - **Flash/Silverlight**ï¼šæ’ä»¶æŠ€æœ¯ï¼Œå·²è¢«ç°ä»£ Web æ ‡å‡†æ·˜æ±°

3. **WebAssembly çš„è¯ç”Ÿ**
   - 2015 å¹´ï¼ŒMozillaã€Googleã€Microsoftã€Apple ç­‰æµè§ˆå™¨å‚å•†è”åˆå‘èµ·
   - 2017 å¹´ 3 æœˆï¼ŒWebAssembly æˆä¸º W3C æ ‡å‡†
   - è®¾è®¡ç›®æ ‡ï¼šæä¾›ä¸€ç§**äºŒè¿›åˆ¶æ ¼å¼**ï¼Œèƒ½å¤Ÿåœ¨ Web å¹³å°ä¸Šä»¥æ¥è¿‘åŸç”Ÿæ€§èƒ½è¿è¡Œä»£ç 

### è®¾è®¡ç›®æ ‡

- âœ… **æ€§èƒ½ä¼˜å…ˆ**ï¼šæ¥è¿‘åŸç”Ÿä»£ç çš„æ‰§è¡Œé€Ÿåº¦
- âœ… **å®‰å…¨æ€§**ï¼šåœ¨æ²™ç®±ç¯å¢ƒä¸­è¿è¡Œï¼Œéµå¾ªæµè§ˆå™¨çš„åŒæºç­–ç•¥
- âœ… **å¯ç§»æ¤æ€§**ï¼šè·¨å¹³å°ã€è·¨æµè§ˆå™¨è¿è¡Œ
- âœ… **å¯è°ƒè¯•æ€§**ï¼šæ”¯æŒ Source Maps å’Œè°ƒè¯•å·¥å…·
- âœ… **ä¸ JavaScript äº’æ“ä½œ**ï¼šæ— ç¼é›†æˆåˆ°ç°æœ‰ Web ç”Ÿæ€

---

## ä»€ä¹ˆæ˜¯ WebAssembly

WebAssembly æ˜¯ä¸€ç§**ä½çº§çš„ã€ç±»ä¼¼æ±‡ç¼–è¯­è¨€çš„äºŒè¿›åˆ¶æŒ‡ä»¤æ ¼å¼**ï¼Œä¸“ä¸º Web å¹³å°è®¾è®¡ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

1. **äºŒè¿›åˆ¶æ ¼å¼ï¼ˆ.wasmï¼‰**
   - ç´§å‡‘çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ŒåŠ è½½å’Œè§£æé€Ÿåº¦å¿«
   - æ¯” JavaScript æ–‡æœ¬æ ¼å¼æ›´å°ã€æ›´å¿«

2. **æ–‡æœ¬æ ¼å¼ï¼ˆ.watï¼‰**
   - WebAssembly Text Formatï¼Œäººç±»å¯è¯»çš„æ–‡æœ¬è¡¨ç¤º
   - ä¸»è¦ç”¨äºè°ƒè¯•å’Œå¼€å‘

3. **è™šæ‹Ÿæœºæ‰§è¡Œ**
   - åœ¨æµè§ˆå™¨çš„è™šæ‹Ÿæœºä¸­æ‰§è¡Œ
   - ä¸ç›´æ¥è®¿é—®ç³»ç»Ÿèµ„æºï¼Œé€šè¿‡ Web API ä¸å¤–ç•Œäº¤äº’

### æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Web Application                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  JavaScript  â”‚  WebAssembly Module     â”‚
â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚              â”‚  â”‚  .wasm Binary    â”‚   â”‚
â”‚              â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚              â”‚  â”‚  â”‚  Functions â”‚ â”‚   â”‚
â”‚              â”‚  â”‚  â”‚  Memory    â”‚ â”‚   â”‚
â”‚              â”‚  â”‚  â”‚  Tables    â”‚ â”‚   â”‚
â”‚              â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         WebAssembly Runtime             â”‚
â”‚  (Browser VM / Standalone Runtime)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç‰¹æ€§

### 1. ç±»å‹ç³»ç»Ÿ

WebAssembly æ˜¯**å¼ºç±»å‹**çš„ï¼Œæ”¯æŒå››ç§åŸºæœ¬ç±»å‹ï¼š

- `i32`ï¼š32 ä½æ•´æ•°
- `i64`ï¼š64 ä½æ•´æ•°
- `f32`ï¼š32 ä½æµ®ç‚¹æ•°
- `f64`ï¼š64 ä½æµ®ç‚¹æ•°

### 2. çº¿æ€§å†…å­˜æ¨¡å‹

- ä½¿ç”¨**çº¿æ€§å†…å­˜**ï¼ˆLinear Memoryï¼‰å­˜å‚¨æ•°æ®
- å†…å­˜æ˜¯ä¸€ä¸ªå¯å¢é•¿çš„å­—èŠ‚æ•°ç»„
- é€šè¿‡ç´¢å¼•è®¿é—®ï¼Œç±»ä¼¼äºæ•°ç»„

### 3. å‡½æ•°è°ƒç”¨

- æ”¯æŒå¯¼å…¥å’Œå¯¼å‡ºå‡½æ•°
- å¯ä»¥ä¸ JavaScript å‡½æ•°ç›¸äº’è°ƒç”¨
- æ”¯æŒå‡½æ•°æŒ‡é’ˆï¼ˆé€šè¿‡ Tableï¼‰

### 4. æ¨¡å—åŒ–

- ä»¥**æ¨¡å—**ï¼ˆModuleï¼‰ä¸ºå•ä½ç»„ç»‡ä»£ç 
- æ¨¡å—å¯ä»¥å¯¼å…¥/å¯¼å‡ºå‡½æ•°ã€å†…å­˜ã€è¡¨ç­‰
- æ”¯æŒåŠ¨æ€é“¾æ¥

---

## ä½œç”¨ä¸åº”ç”¨åœºæ™¯

### ä¸»è¦ä½œç”¨

1. **æ€§èƒ½æå‡**
   - è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ€§èƒ½æå‡ 10-100 å€
   - å‡å°‘ JavaScript å¼•æ“çš„ä¼˜åŒ–å¼€é”€

2. **ä»£ç å¤ç”¨**
   - å°† C/C++/Rust ç­‰è¯­è¨€ç¼–å†™çš„ä»£ç ç¼–è¯‘ä¸º WASM
   - åœ¨ Web å¹³å°ä¸Šå¤ç”¨ç°æœ‰åº“å’Œç®—æ³•

3. **é™ä½åŒ…ä½“ç§¯**
   - äºŒè¿›åˆ¶æ ¼å¼æ¯”å‹ç¼©åçš„ JavaScript æ›´å°
   - å‡å°‘ç½‘ç»œä¼ è¾“æ—¶é—´

4. **å¤šè¯­è¨€æ”¯æŒ**
   - æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼ˆC/C++ã€Rustã€Goã€AssemblyScript ç­‰ï¼‰
   - å¼€å‘è€…å¯ä»¥é€‰æ‹©æœ€é€‚åˆçš„è¯­è¨€

### å…¸å‹åº”ç”¨åœºæ™¯

#### 1. å›¾åƒ/è§†é¢‘å¤„ç†
- å›¾åƒæ»¤é•œã€å‹ç¼©ã€æ ¼å¼è½¬æ¢
- è§†é¢‘ç¼–è§£ç ï¼ˆå¦‚ FFmpeg.wasmï¼‰
- è®¡ç®—æœºè§†è§‰ç®—æ³•

#### 2. æ¸¸æˆå¼€å‘
- æ¸¸æˆå¼•æ“ï¼ˆUnityã€Unreal Engineï¼‰
- ç‰©ç†å¼•æ“ã€ç¢°æ’æ£€æµ‹
- 3D æ¸²æŸ“ç®¡çº¿

#### 3. ç§‘å­¦è®¡ç®—
- æ•°å€¼è®¡ç®—åº“
- æœºå™¨å­¦ä¹ æ¨ç†ï¼ˆTensorFlow.jsã€ONNX Runtimeï¼‰
- å¯†ç å­¦è¿ç®—

#### 4. éŸ³è§†é¢‘åº”ç”¨
- éŸ³é¢‘å¤„ç†ï¼ˆé™å™ªã€æ··éŸ³ï¼‰
- å®æ—¶é€šä¿¡ï¼ˆWebRTC å¢å¼ºï¼‰
- éŸ³ä¹åˆ¶ä½œå·¥å…·

#### 5. å¼€å‘å·¥å…·
- ä»£ç ç¼–è¾‘å™¨ï¼ˆVS Code çš„éƒ¨åˆ†åŠŸèƒ½ï¼‰
- ç¼–è¯‘å™¨å‰ç«¯
- é™æ€åˆ†æå·¥å…·

---

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„è¯­è¨€

| è¯­è¨€ | ä¼˜åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **Rust** | å†…å­˜å®‰å…¨ã€æ€§èƒ½ä¼˜ç§€ã€å·¥å…·é“¾å®Œå–„ | æ–°é¡¹ç›®é¦–é€‰ |
| **C/C++** | ç”Ÿæ€ä¸°å¯Œã€æ€§èƒ½æè‡´ | ç§»æ¤ç°æœ‰ C/C++ åº“ |
| **AssemblyScript** | TypeScript è¯­æ³•ã€å­¦ä¹ æ›²çº¿ä½ | å‰ç«¯å¼€å‘è€…å‹å¥½ |
| **Go** | ç®€å•æ˜“ç”¨ã€å¹¶å‘æ”¯æŒ | å¿«é€ŸåŸå‹å¼€å‘ |

### 2. æ¨¡å—åŠ è½½ä¼˜åŒ–

```javascript
// âŒ ä¸æ¨èï¼šåŒæ­¥åŠ è½½
const wasmModule = await WebAssembly.instantiateStreaming(
  fetch('module.wasm')
);

// âœ… æ¨èï¼šä½¿ç”¨ Worker åŠ è½½ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
// main.js
const worker = new Worker('wasm-worker.js');
worker.postMessage({ type: 'load', url: 'module.wasm' });

// wasm-worker.js
self.onmessage = async (e) => {
  if (e.data.type === 'load') {
    const wasmModule = await WebAssembly.instantiateStreaming(
      fetch(e.data.url)
    );
    self.postMessage({ type: 'loaded', module: wasmModule });
  }
};
```

### 3. å†…å­˜ç®¡ç†

```javascript
// âœ… æ¨èï¼šåˆç†è®¾ç½®åˆå§‹å’Œæœ€å¤§å†…å­˜
const memory = new WebAssembly.Memory({
  initial: 256,  // 256 pages = 16MB
  maximum: 512,  // 512 pages = 32MB
  shared: false  // æ˜¯å¦å…±äº«å†…å­˜ï¼ˆéœ€è¦ SharedArrayBufferï¼‰
});

// âœ… æ¨èï¼šåŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡
function processLargeData(data) {
  const wasmBuffer = new Uint8Array(memory.buffer, 0, data.length);
  wasmBuffer.set(data);
  
  // å¤„ç†æ•°æ®...
  const result = wasmModule.instance.exports.process();
  
  // æ¸…ç†
  wasmBuffer.fill(0);
  return result;
}
```

### 4. é”™è¯¯å¤„ç†

```javascript
// âœ… æ¨èï¼šå®Œå–„çš„é”™è¯¯å¤„ç†
async function loadWasmModule(url) {
  try {
    const wasmModule = await WebAssembly.instantiateStreaming(
      fetch(url),
      {
        // å¯¼å…¥å¯¹è±¡
        env: {
          memory: new WebAssembly.Memory({ initial: 256 }),
          abort: (msg, file, line, column) => {
            console.error(`WASM abort: ${msg} at ${file}:${line}:${column}`);
          }
        }
      }
    );
    return wasmModule;
  } catch (error) {
    if (error instanceof TypeError) {
      // æµè§ˆå™¨ä¸æ”¯æŒ Stream APIï¼Œä½¿ç”¨ ArrayBuffer æ–¹å¼
      const response = await fetch(url);
      const bytes = await response.arrayBuffer();
      return await WebAssembly.instantiate(bytes);
    }
    throw error;
  }
}
```

### 5. æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **æ‰¹é‡å¤„ç†**ï¼šé¿å…é¢‘ç¹çš„ JS â†” WASM è°ƒç”¨
- **ä½¿ç”¨ SharedArrayBuffer**ï¼šå¤šçº¿ç¨‹åœºæ™¯ä¸‹çš„å†…å­˜å…±äº«
- **é¢„ç¼–è¯‘æ¨¡å—**ï¼šä½¿ç”¨ `WebAssembly.compile()` ç¼“å­˜ç¼–è¯‘ç»“æœ
- **æµå¼ç¼–è¯‘**ï¼šä½¿ç”¨ `instantiateStreaming` è¾¹ä¸‹è½½è¾¹ç¼–è¯‘

### 6. è°ƒè¯•æŠ€å·§

```javascript
// âœ… å¯ç”¨ Source Maps
const wasmModule = await WebAssembly.instantiateStreaming(
  fetch('module.wasm'),
  {
    // æä¾›è°ƒè¯•ä¿¡æ¯
    'wasm-bindgen': {
      __wbindgen_throw: (ptr, len) => {
        const memory = wasmModule.instance.exports.memory;
        const msg = new TextDecoder().decode(
          new Uint8Array(memory.buffer, ptr, len)
        );
        throw new Error(msg);
      }
    }
  }
);

// ä½¿ç”¨æµè§ˆå™¨ DevTools
// Chrome DevTools > Sources > WebAssembly æ ‡ç­¾é¡µ
```

---

## ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šä½¿ç”¨ AssemblyScript ç¼–å†™ç®€å•çš„è®¡ç®—å‡½æ•°

#### 1.1 å®‰è£… AssemblyScript

```bash
npm init -y
npm install --save-dev assemblyscript
npx asinit .
```

#### 1.2 ç¼–å†™ AssemblyScript ä»£ç 

```typescript
// assembly/index.ts
export function add(a: i32, b: i32): i32 {
  return a + b;
}

export function factorial(n: i32): i64 {
  if (n <= 1) {
    return 1;
  }
  return n * factorial(n - 1);
}

export function fibonacci(n: i32): i32 {
  if (n <= 1) {
    return n;
  }
  return fibonacci(n - 1) + fibonacci(n - 2);
}

// ä½¿ç”¨å¾ªç¯ä¼˜åŒ–ç‰ˆæœ¬
export function fibonacciIterative(n: i32): i32 {
  if (n <= 1) {
    return n;
  }
  let a: i32 = 0;
  let b: i32 = 1;
  for (let i: i32 = 2; i <= n; i++) {
    const temp = a + b;
    a = b;
    b = temp;
  }
  return b;
}
```

#### 1.3 ç¼–è¯‘ä¸º WebAssembly

```bash
npm run asbuild
```

#### 1.4 åœ¨ JavaScript ä¸­ä½¿ç”¨

```javascript
// index.html
<!DOCTYPE html>
<html>
<head>
  <title>WebAssembly Demo</title>
</head>
<body>
  <h1>WebAssembly è®¡ç®—ç¤ºä¾‹</h1>
  <button onclick="testAdd()">æµ‹è¯•åŠ æ³•</button>
  <button onclick="testFactorial()">æµ‹è¯•é˜¶ä¹˜</button>
  <button onclick="testFibonacci()">æµ‹è¯•æ–æ³¢é‚£å¥‘</button>
  <div id="result"></div>

  <script type="module">
    import { add, factorial, fibonacci, fibonacciIterative } from './build/release.js';

    window.testAdd = () => {
      const start = performance.now();
      const result = add(42, 58);
      const end = performance.now();
      document.getElementById('result').innerHTML = 
        `ç»“æœ: ${result}, è€—æ—¶: ${(end - start).toFixed(4)}ms`;
    };

    window.testFactorial = () => {
      const start = performance.now();
      const result = factorial(20);
      const end = performance.now();
      document.getElementById('result').innerHTML = 
        `20! = ${result}, è€—æ—¶: ${(end - start).toFixed(4)}ms`;
    };

    window.testFibonacci = () => {
      const n = 40;
      
      // JavaScript ç‰ˆæœ¬
      const jsStart = performance.now();
      const jsResult = fibJS(n);
      const jsEnd = performance.now();
      
      // WebAssembly ç‰ˆæœ¬ï¼ˆé€’å½’ï¼‰
      const wasmStart = performance.now();
      const wasmResult = fibonacci(n);
      const wasmEnd = performance.now();
      
      // WebAssembly ç‰ˆæœ¬ï¼ˆè¿­ä»£ï¼‰
      const wasmIterStart = performance.now();
      const wasmIterResult = fibonacciIterative(n);
      const wasmIterEnd = performance.now();
      
      document.getElementById('result').innerHTML = `
        <h3>è®¡ç®— Fibonacci(${n})</h3>
        <p>JavaScript: ${jsResult}, è€—æ—¶: ${(jsEnd - jsStart).toFixed(4)}ms</p>
        <p>WASM (é€’å½’): ${wasmResult}, è€—æ—¶: ${(wasmIterEnd - wasmIterStart).toFixed(4)}ms</p>
        <p>WASM (è¿­ä»£): ${wasmIterResult}, è€—æ—¶: ${(wasmIterEnd - wasmIterStart).toFixed(4)}ms</p>
      `;
    };

    function fibJS(n) {
      if (n <= 1) return n;
      return fibJS(n - 1) + fibJS(n - 2);
    }
  </script>
</body>
</html>
```

### ç¤ºä¾‹ 2ï¼šå›¾åƒå¤„ç† - ç°åº¦è½¬æ¢

#### 2.1 AssemblyScript ä»£ç 

```typescript
// assembly/image.ts
export function grayscale(
  imageDataPtr: usize,
  width: i32,
  height: i32
): void {
  const length = width * height * 4; // RGBA
  
  for (let i = 0; i < length; i += 4) {
    const r = load<u8>(imageDataPtr + i);
    const g = load<u8>(imageDataPtr + i + 1);
    const b = load<u8>(imageDataPtr + i + 2);
    
    // ç°åº¦å…¬å¼ï¼š0.299*R + 0.587*G + 0.114*B
    const gray = u8(
      (0.299 * r + 0.587 * g + 0.114 * b) as f32
    );
    
    store<u8>(imageDataPtr + i, gray);     // R
    store<u8>(imageDataPtr + i + 1, gray); // G
    store<u8>(imageDataPtr + i + 2, gray); // B
    // A é€šé“ä¿æŒä¸å˜
  }
}
```

#### 2.2 JavaScript è°ƒç”¨ä»£ç 

```javascript
// image-processor.js
import { grayscale, memory } from './build/release.js';

export class ImageProcessor {
  constructor() {
    this.memory = memory;
    this.imageDataPtr = null;
  }

  processImage(imageData) {
    const { data, width, height } = imageData;
    
    // åˆ†é…å†…å­˜
    const imageDataSize = data.length;
    this.imageDataPtr = this.memory.alloc(imageDataSize);
    
    // å¤åˆ¶å›¾åƒæ•°æ®åˆ° WASM å†…å­˜
    const wasmBuffer = new Uint8Array(
      this.memory.buffer,
      this.imageDataPtr,
      imageDataSize
    );
    wasmBuffer.set(data);
    
    // è°ƒç”¨ WASM å‡½æ•°
    const start = performance.now();
    grayscale(this.imageDataPtr, width, height);
    const end = performance.now();
    
    // å¤åˆ¶ç»“æœå› JavaScript
    const result = new ImageData(
      new Uint8ClampedArray(wasmBuffer),
      width,
      height
    );
    
    // é‡Šæ”¾å†…å­˜
    this.memory.free(this.imageDataPtr);
    
    console.log(`å¤„ç†è€—æ—¶: ${(end - start).toFixed(2)}ms`);
    return result;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const image = new Image();
image.src = 'photo.jpg';

image.onload = () => {
  ctx.drawImage(image, 0, 0);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  
  const processor = new ImageProcessor();
  const processedData = processor.processImage(imageData);
  
  ctx.putImageData(processedData, 0, 0);
};
```


---

## æ€§èƒ½å¯¹æ¯”

### åŸºå‡†æµ‹è¯•ç¤ºä¾‹

```javascript
// benchmark.js
async function benchmark() {
  // åŠ è½½ WASM æ¨¡å—
  const wasmModule = await import('./build/release.js');
  
  const iterations = 1000000;
  const testValue = 1000;
  
  // JavaScript ç‰ˆæœ¬
  function jsFibonacci(n) {
    if (n <= 1) return n;
    return jsFibonacci(n - 1) + jsFibonacci(n - 2);
  }
  
  // æµ‹è¯• JavaScript
  const jsStart = performance.now();
  for (let i = 0; i < iterations; i++) {
    jsFibonacci(30);
  }
  const jsEnd = performance.now();
  const jsTime = jsEnd - jsStart;
  
  // æµ‹è¯• WebAssembly
  const wasmStart = performance.now();
  for (let i = 0; i < iterations; i++) {
    wasmModule.fibonacci(30);
  }
  const wasmEnd = performance.now();
  const wasmTime = wasmEnd - wasmStart;
  
  console.log('æ€§èƒ½å¯¹æ¯”ç»“æœ:');
  console.log(`JavaScript: ${jsTime.toFixed(2)}ms`);
  console.log(`WebAssembly: ${wasmTime.toFixed(2)}ms`);
  console.log(`æ€§èƒ½æå‡: ${(jsTime / wasmTime).toFixed(2)}x`);
}

benchmark();
```

### å…¸å‹æ€§èƒ½æå‡

| ä»»åŠ¡ç±»å‹ | JavaScript | WebAssembly | æå‡å€æ•° |
|---------|-----------|-------------|---------|
| æ•°å€¼è®¡ç®— | 100ms | 10ms | 10x |
| å›¾åƒå¤„ç† | 500ms | 50ms | 10x |
| çŸ©é˜µè¿ç®— | 200ms | 15ms | 13x |
| åŠ å¯†ç®—æ³• | 300ms | 20ms | 15x |

*æ³¨ï¼šå®é™…æ€§èƒ½æå‡å–å†³äºå…·ä½“ä»»åŠ¡å’Œæµè§ˆå™¨å®ç°*

---

## æ€»ç»“

### WebAssembly çš„ä¼˜åŠ¿

1. âœ… **é«˜æ€§èƒ½**ï¼šæ¥è¿‘åŸç”Ÿä»£ç çš„æ‰§è¡Œé€Ÿåº¦
2. âœ… **å¤šè¯­è¨€æ”¯æŒ**ï¼šå¯ä»¥ä½¿ç”¨ C/C++ã€Rustã€Go ç­‰è¯­è¨€å¼€å‘
3. âœ… **å®‰å…¨æ€§**ï¼šåœ¨æ²™ç®±ç¯å¢ƒä¸­è¿è¡Œ
4. âœ… **å¯ç§»æ¤æ€§**ï¼šè·¨å¹³å°ã€è·¨æµè§ˆå™¨
5. âœ… **ç”Ÿæ€å…¼å®¹**ï¼šä¸ç°æœ‰ Web æŠ€æœ¯æ— ç¼é›†æˆ

### é€‚ç”¨åœºæ™¯

- âœ… è®¡ç®—å¯†é›†å‹ä»»åŠ¡
- âœ… éœ€è¦å¤ç”¨ç°æœ‰ C/C++/Rust åº“
- âœ… æ€§èƒ½å…³é”®çš„åº”ç”¨ï¼ˆæ¸¸æˆã€ç¼–è¾‘å™¨ã€ç§‘å­¦è®¡ç®—ï¼‰
- âœ… éœ€è¦é™ä½åŒ…ä½“ç§¯çš„åœºæ™¯

### ä¸é€‚ç”¨åœºæ™¯

- âŒ ç®€å•çš„ DOM æ“ä½œï¼ˆJavaScript æ›´åˆé€‚ï¼‰
- âŒ éœ€è¦é¢‘ç¹è®¿é—®æµè§ˆå™¨ API çš„åœºæ™¯
- âŒ å°å‹é¡¹ç›®ï¼ˆå¼•å…¥ WASM çš„å¤æ‚åº¦å¯èƒ½ä¸å€¼å¾—ï¼‰

### æœªæ¥å±•æœ›

- **WASIï¼ˆWebAssembly System Interfaceï¼‰**ï¼šæ ‡å‡†åŒ–ç³»ç»Ÿè°ƒç”¨æ¥å£
- **çº¿ç¨‹æ”¯æŒ**ï¼šå¤šçº¿ç¨‹ WebAssembly åº”ç”¨
- **GC ææ¡ˆ**ï¼šæ”¯æŒåƒåœ¾å›æ”¶ï¼Œç®€åŒ–å†…å­˜ç®¡ç†
- **ç»„ä»¶æ¨¡å‹**ï¼šæ›´å¥½çš„æ¨¡å—åŒ–å’Œäº’æ“ä½œæ€§

---

## å‚è€ƒèµ„æ–™

- [WebAssembly å®˜æ–¹æ–‡æ¡£](https://webassembly.org/)
- [MDN WebAssembly æŒ‡å—](https://developer.mozilla.org/zh-CN/docs/WebAssembly)
- [AssemblyScript æ–‡æ¡£](https://www.assemblyscript.org/)
- [Rust å’Œ WebAssembly](https://rustwasm.github.io/docs/book/)
- [WebAssembly è§„èŒƒ](https://webassembly.github.io/spec/)

---
